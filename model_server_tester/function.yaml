kind: job
metadata:
  name: model-server-tester
  tag: ''
  hash: bcf856150a1b54cd9c5eb7378fc91fb97da38c02
  project: ''
  labels:
    author: yaronh
  categories:
  - models
  - testing
spec:
  command: ''
  args: []
  image: mlrun/mlrun
  env: []
  default_handler: model_server_tester
  description: test model servers
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTA2IDIzOjI4CgppbXBvcnQgb3MKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgcmVxdWVzdHMKaW1wb3J0IGpzb24KZnJvbSBkYXRldGltZSBpbXBvcnQgZGF0ZXRpbWUKCmRlZiBtb2RlbF9zZXJ2ZXJfdGVzdGVyKGNvbnRleHQsCiAgICAgICAgICAgICAgICAgICAgICB0YWJsZTogc3RyLAogICAgICAgICAgICAgICAgICAgICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWwiLAogICAgICAgICAgICAgICAgICAgICAgYWRkcj0nJywgCiAgICAgICAgICAgICAgICAgICAgICBtb2RlbD0nJywKICAgICAgICAgICAgICAgICAgICAgIG1hdGNoX2Vycj1GYWxzZSwKICAgICAgICAgICAgICAgICAgICAgIHJvd3M9MTApOgogICAgIiIiIFRlc3QgYSBtb2RlbCBzZXJ2ZXIgIiIiCiAgICAKICAgIAogICAgdGFibGUgPSBzdHIodGFibGUpCiAgICBpZiB0YWJsZS5lbmRzd2l0aCgiLmNzdiIpOgogICAgICAgIHRhYmxlID0gcGQucmVhZF9jc3YodGFibGUpCiAgICBlbHNlOiAKICAgICAgICB0YWJsZSA9IHBkLnJlYWRfcGFycXVldCh0YWJsZSkKCiAgICB5X2xpc3QgPSB0YWJsZS5wb3AobGFiZWxfY29sdW1uKS52YWx1ZXMudG9saXN0KCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZid0ZXN0aW5nIHdpdGggZGF0YXNldCBhZ2FpbnN0IHthZGRyfSwgbW9kZWw6IHttb2RlbH0nKQogICAgaWYgcm93czoKICAgICAgICB0YWJsZSA9IHRhYmxlLnNhbXBsZShyb3dzKQogICAgCiAgICBjb3VudCA9IGVycl9jb3VudCA9IG1hdGNoID0gdG90YWxfdGltZSA9IDAKICAgIGZvciB4LCB5IGluIHppcCh0YWJsZS52YWx1ZXMsIHlfbGlzdCk6CiAgICAgICAgY291bnQgKz0gMQogICAgICAgIGV2ZW50X2RhdGEgPSBqc29uLmR1bXBzKHsiaW5zdGFuY2VzIjpbeC50b2xpc3QoKV19KQogICAgICAgIGhhZF9lcnIgPSBGYWxzZQogICAgICAgIHRyeToKICAgICAgICAgICAgc3RhcnQgPSBkYXRldGltZS5ub3coKQogICAgICAgICAgICByZXNwID0gcmVxdWVzdHMucHV0KGYne2FkZHJ9L3ttb2RlbH0vcHJlZGljdCcsIGpzb249ZXZlbnRfZGF0YSkKICAgICAgICAgICAgaWYgbm90IHJlc3Aub2s6CiAgICAgICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5lcnJvcihmJ2JhZCBmdW5jdGlvbiByZXNwISFcbntyZXNwLnRleHR9JykKICAgICAgICAgICAgICAgIGVycl9jb3VudCArPSAxCiAgICAgICAgICAgICAgICBjb250aW51ZQogICAgICAgICAgICB0b3RhbF90aW1lICs9IChkYXRldGltZS5ub3coKS1zdGFydCkubWljcm9zZWNvbmRzCiAgICAgICAgICAgICAgICAKICAgICAgICBleGNlcHQgT1NFcnJvciBhcyBlcnI6CiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmVycm9yKGYnZXJyb3IgaW4gcmVxdWVzdCwgZGF0YTp7ZXZlbnRfZGF0YX0sIGVycm9yOiB7ZXJyfScpCiAgICAgICAgICAgIGVycl9jb3VudCArPSAxCiAgICAgICAgICAgIGNvbnRpbnVlCiAgICAgICAgICAgIAogICAgICAgIHlfcmVzcCA9IHJlc3AuanNvbigpWzBdCiAgICAgICAgaWYgeSA9PSB5X3Jlc3A6CiAgICAgICAgICAgIG1hdGNoICs9IDEKICAgICAgICAKICAgIGNvbnRleHQubG9nX3Jlc3VsdCgndG90YWxfdGVzdHMnLCBjb3VudCkKICAgIGNvbnRleHQubG9nX3Jlc3VsdCgnZXJyb3JzJywgZXJyX2NvdW50KQogICAgY29udGV4dC5sb2dfcmVzdWx0KCdtYXRjaCcsIG1hdGNoKQogICAgaWYgY291bnQgLSBlcnJfY291bnQgPiAwOgogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdCgnYXZnX2xhdGVuY3knLCBpbnQodG90YWxfdGltZSAvIChjb3VudCAtIGVycl9jb3VudCkpKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ3J1biB7Y291bnR9IHRlc3RzLCB7ZXJyX2NvdW50fSBlcnJvcnMgYW5kIHttYXRjaH0gbWF0Y2ggZXhwZWN0ZWQgdmFsdWUnKQogICAgCiAgICBpZiBlcnJfY291bnQ6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcihmJ2ZhaWxlZCBvbiB7ZXJyX2NvdW50fSB0ZXN0cyBvZiB7Y291bnR9JykKICAgIAogICAgaWYgbWF0Y2hfZXJyIGFuZCBtYXRjaCAhPSBjb3VudDoKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKGYnb25seSB7bWF0Y2h9IHJlc3VsdHMgbWF0Y2ggb3V0IG9mIHtjb3VudH0nKQoK
    commands: []
    code_origin: https://github.com/mlrun/demos.git#49b1a461bcc34436fb5d90640088ba1b5ddf6c2a:model_server_tester.ipynb
