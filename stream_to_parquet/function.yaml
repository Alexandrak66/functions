kind: remote
metadata:
  name: stream-to-parquet
  tag: ''
  hash: 71ae433912666d0b3f80c07051bfe4fc7107bb76
  project: default
  labels:
    author: orz
  categories:
  - ml
  - serve
spec:
  command: ''
  args: []
  image: ''
  entry_points:
    record_to_features:
      name: record_to_features
      doc: ''
      parameters:
      - name: context
        default: ''
      - name: record
        default: ''
      outputs:
      - default: ''
      lineno: 11
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        default: ''
      outputs:
      - default: ''
      lineno: 17
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 61
  description: Saves a stream to Parquet and can lunch drift detection task on it
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      annotations:
        nuclio.io/generated_by: function generated from 06-08-2020 by admin
      labels: {}
      name: stream-to-parquet
    spec:
      build:
        baseImage: mlrun/ml-models
        commands: []
        functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBqc29uCmltcG9ydCBkYXRldGltZQppbXBvcnQgbWxydW4KZnJvbSBhc3QgaW1wb3J0IGxpdGVyYWxfZXZhbAoKZGVmIHJlY29yZF90b19mZWF0dXJlcyhjb250ZXh0LCByZWNvcmQpOgogICAgZmVhdHVyZXMgPSByZWNvcmRbJ3JlcXVlc3QnXVsnaW5zdGFuY2VzJ11bMF0KICAgIHRpbWVzdGFtcCA9IHJlY29yZFsnd2hlbiddCiAgICAKICAgIHJldHVybiBbdGltZXN0YW1wXSArIFtmZWF0dXJlc1tmZWF0dXJlXSBmb3IgZmVhdHVyZSBpbiBjb250ZXh0LmNvbHVtbnMgaWYgZmVhdHVyZSBpZiBmZWF0dXJlICE9ICd0aW1lc3RhbXAnXQoKZGVmIGluaXRfY29udGV4dChjb250ZXh0KToKICAgIHNldGF0dHIoY29udGV4dCwgJ2JhdGNoJywgW10pCiAgICBzZXRhdHRyKGNvbnRleHQsICd3aW5kb3cnLCBpbnQob3MuZ2V0ZW52KCd3aW5kb3cnLCAxMCkpKQogICAgCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdTZXR0aW5nIGNvbHVtbnMgZm9yIHRyYWNraW5nJykKICAgIGNvbHVtbnMgPSBbXQogICAgZmVhdHVyZXMgPSBvcy5nZXRlbnYoJ2ZlYXR1cmVzJywgTm9uZSkKICAgIGlmIGZlYXR1cmVzIGlzIG5vdCBOb25lOgogICAgICAgIGlmIGZlYXR1cmVzWzoxXSA9PSAnWycgYW5kIGZlYXR1cmVzWy0xOl0gPT0gJ10nOgogICAgICAgICAgICBjb2x1bW5zID0gbGl0ZXJhbF9ldmFsKGZlYXR1cmVzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZlYXR1cmVzID0gZmVhdHVyZXMuc3BsaXQoJywnKSAgICAKICAgICAgICAgICAgY29sdW1ucyArPSBmZWF0dXJlcwogICAgc2V0YXR0cihjb250ZXh0LCAnZmVhdHVyZXMnLCBmZWF0dXJlcykKICAgICAgICAKICAgIHByZWRpY3Rpb25zID0gb3MuZ2V0ZW52KCdwcmVkaWN0aW9uc19jb2wnLCBOb25lKQogICAgaWYgcHJlZGljdGlvbnMgaXMgbm90IE5vbmU6CiAgICAgICAgcHJlZGljdGlvbnMgPSBwcmVkaWN0aW9ucy5zcGxpdCgnLCcpCiAgICAgICAgY29sdW1ucyArPSBwcmVkaWN0aW9ucwogICAgICAgIAogICAgbGFiZWxfY29sID0gb3MuZ2V0ZW52KCdsYWJlbF9jb2wnLCBOb25lKQogICAgaWYgbGFiZWxfY29sIGlzIG5vdCBOb25lOgogICAgICAgIGxhYmVsX2NvbCA9IGxhYmVsX2NvbC5zcGxpdCgnLCcpCiAgICAgICAgY29sdW1ucyArPSBsYWJlbF9jb2wKICAgIHNldGF0dHIoY29udGV4dCwgJ2NvbHVtbnMnLCBbJ3RpbWVzdGFtcCddICsgY29sdW1ucykKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidUcmFja2luZyB7Y29sdW1uc30nKQogICAgCiAgICBzZXRhdHRyKGNvbnRleHQsICdzYXZlX3RvJywgb3MuZ2V0ZW52KCdzYXZlX3RvJywgJy9iaWdkYXRhL2luZmVyZW5jZV9wcS8nKSkKICAgIG9zLm1ha2VkaXJzKGNvbnRleHQuc2F2ZV90bywgZXhpc3Rfb2s9VHJ1ZSkKICAgIAogICAgY29udGV4dC5sb2dnZXIuaW5mbygnU2V0dGluZyBkcmlmdCBmdW5jdGlvbicpCiAgICBtbHJ1bi5tbGNvbmYuZGJwYXRoID0gbWxydW4ubWxjb25mLmRicGF0aCBvciAnaHR0cDovL21scnVuLWFwaTo4MDgwJwogICAgaWYgJ2h1Yl91cmwnIGluIG9zLmVudmlyb246CiAgICAgICAgbWxydW4ubWxjb25mLmh1Yl91cmwgPSBvcy5lbnZpcm9uWydodWJfdXJsJ10KICAgIHZpcnR1YWxfZHJpZnRfZm4gPSBtbHJ1bi5pbXBvcnRfZnVuY3Rpb24oJ2h1YjovL3ZpcnR1YWxfZHJpZnQnKQogICAgdmlydHVhbF9kcmlmdF9mbi5hcHBseShtbHJ1bi5tb3VudF92M2lvKG5hbWU9J3Zmbl9tb3VudCcsIG1vdW50X3BhdGg9b3MuZ2V0ZW52KCdtb3VudF9wYXRoJywgJ34vJyksIHJlbW90ZT1vcy5nZXRlbnYoJ21vdW50X3JlbW90ZScsICcvVXNlcicpKSkKICAgIHNldGF0dHIoY29udGV4dCwgJ3ZpcnR1YWxfZHJpZnRfZm4nLCB2aXJ0dWFsX2RyaWZ0X2ZuKQogICAgc2V0YXR0cihjb250ZXh0LCAnYmFzZV9kYXRhc2V0Jywgb3MuZ2V0ZW52KCdiYXNlX2RhdGFzZXQnLCAnJykpCiAgICAKICAgIHNldGF0dHIoY29udGV4dCwgJ2xhYmVsX2NvbCcsIGxhYmVsX2NvbCkKICAgIHNldGF0dHIoY29udGV4dCwgJ3Jlc3VsdHNfdHNkYl9jb250YWluZXInLCBvcy5nZXRlbnYoJ3Jlc3VsdHNfdHNkYl9jb250YWluZXInLCBOb25lKSkKICAgIHNldGF0dHIoY29udGV4dCwgJ3Jlc3VsdHNfdHNkYl90YWJsZScsIG9zLmdldGVudigncmVzdWx0c190c2RiX3RhYmxlJywgTm9uZSkpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdTdWNjZXNzZnVseSBhc3NpZ25lZCBhbGwgZnVuY3Rpb24gcGFyYW1ldGVycycpCgpkZWYgaGFuZGxlcihjb250ZXh0LCBldmVudCk6CiAgICAKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidBZGRpbmcge2V2ZW50LmJvZHl9JykKICAgIGV2ZW50X2JvZHkgPSBldmVudC5ib2R5CiAgICBpZiB0eXBlKGV2ZW50X2JvZHkpID09IHN0cjoKICAgICAgICBldmVudF9ib2R5ID0ganNvbi5sb2FkcyhldmVudF9ib2R5KQogICAgY29udGV4dC5iYXRjaC5hcHBlbmQocmVjb3JkX3RvX2ZlYXR1cmVzKGNvbnRleHQsIGV2ZW50X2JvZHkpKQogICAgCiAgICBpZiBsZW4oY29udGV4dC5iYXRjaCkgPiBjb250ZXh0LndpbmRvdzoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGNvbnRleHQuYmF0Y2gpCiAgICAgICAgZGYgPSBwZC5EYXRhRnJhbWUoZGF0YT1jb250ZXh0LmJhdGNoLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnM9Y29udGV4dC5jb2x1bW5zKQogICAgICAgIGRmX3BhdGggPSBvcy5wYXRoLmpvaW4oY29udGV4dC5zYXZlX3RvLCBmIntkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgnJVktJW0tJWRUJUg6JU06JVMnKX0ucHEiKQogICAgICAgIGRmLnRvX3BhcnF1ZXQoZGZfcGF0aCkKCiAgICAgICAgdGFzayA9IG1scnVuLk5ld1Rhc2sobmFtZT0nZHJpZnRfbWFnbml0dWRlJywKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcj0nZHJpZnRfbWFnbml0dWRlJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zPXsnbGFiZWxfY29sJzogY29udGV4dC5sYWJlbF9jb2wsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jlc3VsdHNfdHNkYl9jb250YWluZXInOiBjb250ZXh0LnJlc3VsdHNfdHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jlc3VsdHNfdHNkYl90YWJsZSc6IGNvbnRleHQucmVzdWx0c190c2RiX3RhYmxlfSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRzPXsndCc6IGNvbnRleHQuYmFzZV9kYXRhc2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1JzogZGZfcGF0aH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGFydGlmYWN0X3BhdGg9bWxydW4ubWxjb25mLmFydGlmYWN0X3BhdGgpCiAgICAgICAgCiAgICAgICAgY29udGV4dC52aXJ0dWFsX2RyaWZ0X2ZuLnJ1bih0YXNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2g9RmFsc2UpCiAgICAgICAgCiAgICAgICAgY29udGV4dC5iYXRjaCA9IFtdCgo=
        noBaseImagesPull: true
      env: []
      handler: stream_to_parquet:handler
      runtime: python:3.6
      volumes: []
  source: ''
