kind: remote
metadata:
  name: stream-to-parquet
  tag: ''
  hash: 3ab29405b2d1f023c4bda2ec0c63d0158009265e
  project: default
  labels:
    author: orz
  categories:
  - ml
  - serve
spec:
  command: ''
  args: []
  image: ''
  entry_points:
    record_to_features:
      name: record_to_features
      doc: ''
      parameters:
      - name: record
        default: ''
      outputs:
      - default: ''
      lineno: 11
    init_context:
      name: init_context
      doc: ''
      parameters:
      - name: context
        default: ''
      outputs:
      - default: ''
      lineno: 18
    handler:
      name: handler
      doc: ''
      parameters:
      - name: context
        default: ''
      - name: event
        default: ''
      outputs:
      - default: ''
      lineno: 62
  description: Saves a stream to Parquet and can lunch drift detection task on it
  min_replicas: 1
  max_replicas: 4
  env: []
  base_spec:
    apiVersion: nuclio.io/v1
    kind: Function
    metadata:
      annotations:
        nuclio.io/generated_by: function generated from 05-08-2020 by admin
      labels: {}
      name: stream-to-parquet
    spec:
      build:
        baseImage: mlrun/ml-models
        commands: []
        functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlcgoKaW1wb3J0IG9zCmltcG9ydCBwYW5kYXMgYXMgcGQKaW1wb3J0IG51bXB5IGFzIG5wCmltcG9ydCBqc29uCmltcG9ydCBkYXRldGltZQppbXBvcnQgbWxydW4KZnJvbSBhc3QgaW1wb3J0IGxpdGVyYWxfZXZhbAoKZGVmIHJlY29yZF90b19mZWF0dXJlcyhyZWNvcmQpOgogICAgZmVhdHVyZXMgPSByZWNvcmRbJ3JlcXVlc3QnXVsnaW5zdGFuY2VzJ11bMF0KICAgIHRpbWVzdGFtcCA9IHJlY29yZFsnd2hlbiddCiAgICBwcmVkaWN0aW9uID0gcmVjb3JkWydyZXNwJ10KICAgIAogICAgcmV0dXJuIFt0aW1lc3RhbXBdICsgW2ZlYXR1cmUgZm9yIGZlYXR1cmUgaW4gZmVhdHVyZXNdICsgcHJlZGljdGlvbgoKZGVmIGluaXRfY29udGV4dChjb250ZXh0KToKICAgIHNldGF0dHIoY29udGV4dCwgJ2JhdGNoJywgW10pCiAgICBzZXRhdHRyKGNvbnRleHQsICd3aW5kb3cnLCBpbnQob3MuZ2V0ZW52KCd3aW5kb3cnLCAxMCkpKQogICAgCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdTZXR0aW5nIGNvbHVtbnMgZm9yIHRyYWNraW5nJykKICAgIGNvbHVtbnMgPSBbXQogICAgZmVhdHVyZXMgPSBvcy5nZXRlbnYoJ2ZlYXR1cmVzJywgTm9uZSkKICAgIGlmIGZlYXR1cmVzIGlzIG5vdCBOb25lOgogICAgICAgIGlmIGZlYXR1cmVzWzoxXSA9PSAnWycgYW5kIGZlYXR1cmVzWy0xOl0gPT0gJ10nOgogICAgICAgICAgICBjb2x1bW5zID0gbGl0ZXJhbF9ldmFsKGZlYXR1cmVzKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZlYXR1cmVzID0gZmVhdHVyZXMuc3BsaXQoJywnKSAgICAKICAgICAgICAgICAgY29sdW1ucyArPSBmZWF0dXJlcwogICAgc2V0YXR0cihjb250ZXh0LCAnZmVhdHVyZXMnLCBmZWF0dXJlcykKICAgICAgICAKICAgIHByZWRpY3Rpb25zID0gb3MuZ2V0ZW52KCdwcmVkaWN0aW9ucycsIE5vbmUpCiAgICBpZiBwcmVkaWN0aW9ucyBpcyBub3QgTm9uZToKICAgICAgICBwcmVkaWN0aW9ucyA9IHByZWRpY3Rpb25zLnNwbGl0KCcsJykKICAgICAgICBjb2x1bW5zICs9IHByZWRpY3Rpb25zCiAgICAgICAgCiAgICBsYWJlbF9jb2wgPSBvcy5nZXRlbnYoJ2xhYmVsX2NvbCcsIE5vbmUpCiAgICBpZiBsYWJlbF9jb2wgaXMgbm90IE5vbmU6CiAgICAgICAgbGFiZWxfY29sID0gbGFiZWxfY29sLnNwbGl0KCcsJykKICAgICAgICBjb2x1bW5zICs9IGxhYmVsX2NvbAogICAgc2V0YXR0cihjb250ZXh0LCAnY29sdW1ucycsIFsndGltZXN0YW1wJ10gKyBjb2x1bW5zKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ1RyYWNraW5nIHtjb2x1bW5zfScpCiAgICAKICAgIHNldGF0dHIoY29udGV4dCwgJ3NhdmVfdG8nLCBvcy5nZXRlbnYoJ3NhdmVfdG8nLCAnL2JpZ2RhdGEvaW5mZXJlbmNlX3BxLycpKQogICAgb3MubWFrZWRpcnMoY29udGV4dC5zYXZlX3RvLCBleGlzdF9vaz1UcnVlKQogICAgCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdTZXR0aW5nIGRyaWZ0IGZ1bmN0aW9uJykKICAgIG1scnVuLm1sY29uZi5kYnBhdGggPSBtbHJ1bi5tbGNvbmYuZGJwYXRoIG9yICdodHRwOi8vbWxydW4tYXBpOjgwODAnCiAgICBpZiAnaHViX3VybCcgaW4gb3MuZW52aXJvbjoKICAgICAgICBtbHJ1bi5tbGNvbmYuaHViX3VybCA9IG9zLmVudmlyb25bJ2h1Yl91cmwnXQogICAgdmlydHVhbF9kcmlmdF9mbiA9IG1scnVuLmltcG9ydF9mdW5jdGlvbignaHViOi8vdmlydHVhbF9kcmlmdCcpCiAgICB2aXJ0dWFsX2RyaWZ0X2ZuLmFwcGx5KG1scnVuLm1vdW50X3YzaW8obmFtZT0ndmZuX21vdW50JywgbW91bnRfcGF0aD1vcy5nZXRlbnYoJ21vdW50X3BhdGgnLCAnfi8nKSwgcmVtb3RlPW9zLmdldGVudignbW91bnRfcmVtb3RlJywgJy9Vc2VyJykpKQogICAgc2V0YXR0cihjb250ZXh0LCAndmlydHVhbF9kcmlmdF9mbicsIHZpcnR1YWxfZHJpZnRfZm4pCiAgICBzZXRhdHRyKGNvbnRleHQsICdiYXNlX2RhdGFzZXQnLCBvcy5nZXRlbnYoJ2Jhc2VfZGF0YXNldCcsICcnKSkKICAgIAogICAgc2V0YXR0cihjb250ZXh0LCAnbGFiZWxfY29sJywgbGFiZWxfY29sKQogICAgc2V0YXR0cihjb250ZXh0LCAncmVzdWx0c190c2RiX2NvbnRhaW5lcicsIG9zLmdldGVudigncmVzdWx0c190c2RiX2NvbnRhaW5lcicsIE5vbmUpKQogICAgc2V0YXR0cihjb250ZXh0LCAncmVzdWx0c190c2RiX3RhYmxlJywgb3MuZ2V0ZW52KCdyZXN1bHRzX3RzZGJfdGFibGUnLCBOb25lKSkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ1N1Y2Nlc3NmdWx5IGFzc2lnbmVkIGFsbCBmdW5jdGlvbiBwYXJhbWV0ZXJzJykKCmRlZiBoYW5kbGVyKGNvbnRleHQsIGV2ZW50KToKICAgIAogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ0FkZGluZyB7ZXZlbnQuYm9keX0nKQogICAgY29udGV4dC5iYXRjaC5hcHBlbmQocmVjb3JkX3RvX2ZlYXR1cmVzKGpzb24ubG9hZHMoZXZlbnQuYm9keSkpKQogICAgCiAgICBpZiBsZW4oY29udGV4dC5iYXRjaCkgPiBjb250ZXh0LndpbmRvdzoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGNvbnRleHQuYmF0Y2gpCiAgICAgICAgZGYgPSBwZC5EYXRhRnJhbWUoZGF0YT1jb250ZXh0LmJhdGNoLAogICAgICAgICAgICAgICAgICAgICAgICAgIGNvbHVtbnM9Y29udGV4dC5jb2x1bW5zKQogICAgICAgIGRmX3BhdGggPSBvcy5wYXRoLmpvaW4oY29udGV4dC5zYXZlX3RvLCBmIntkYXRldGltZS5kYXRldGltZS5ub3coKS5zdHJmdGltZSgnJVktJW0tJWRUJUg6JU06JVMnKX0ucHEiKQogICAgICAgIGRmLnRvX3BhcnF1ZXQoZGZfcGF0aCkKCiAgICAgICAgdGFzayA9IG1scnVuLk5ld1Rhc2sobmFtZT0nZHJpZnRfbWFnbml0dWRlJywKICAgICAgICAgICAgICAgICAgICAgICAgaGFuZGxlcj0nZHJpZnRfbWFnbml0dWRlJywKICAgICAgICAgICAgICAgICAgICAgICAgcGFyYW1zPXsnbGFiZWxfY29sJzogY29udGV4dC5sYWJlbF9jb2wsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jlc3VsdHNfdHNkYl9jb250YWluZXInOiBjb250ZXh0LnJlc3VsdHNfdHNkYl9jb250YWluZXIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgJ3Jlc3VsdHNfdHNkYl90YWJsZSc6IGNvbnRleHQucmVzdWx0c190c2RiX3RhYmxlfSwKICAgICAgICAgICAgICAgICAgICAgICAgaW5wdXRzPXsndCc6IGNvbnRleHQuYmFzZV9kYXRhc2V0LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICd1JzogZGZfcGF0aH0sCiAgICAgICAgICAgICAgICAgICAgICAgIGFydGlmYWN0X3BhdGg9bWxydW4ubWxjb25mLmFydGlmYWN0X3BhdGgpCiAgICAgICAgCiAgICAgICAgY29udGV4dC52aXJ0dWFsX2RyaWZ0X2ZuLnJ1bih0YXNrLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgd2F0Y2g9RmFsc2UpCiAgICAgICAgCiAgICAgICAgY29udGV4dC5iYXRjaCA9IFtdCgo=
        noBaseImagesPull: true
      env: []
      handler: stream_to_parquet:handler
      runtime: python:3.6
      volumes: []
  source: ''
