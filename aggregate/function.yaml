kind: job
metadata:
  name: aggregate
  tag: ''
  hash: c9349c72c4286fb7a8d9ed68d8d927e4c5425acb
  project: ''
  categories:
  - preprocessing
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: aggregate
  description: Rolling aggregation over Metrics and Lables according to specifications
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTAxIDEzOjM5CgppbXBvcnQgb3MKaW1wb3J0IHBhbmRhcyBhcyBwZAoKZnJvbSB0eXBpbmcgaW1wb3J0IFVuaW9uCmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQoKZGVmIGFnZ3JlZ2F0ZShjb250ZXh0LAogICAgICAgICAgICAgIGRmX2FydGlmYWN0OiBVbmlvbltEYXRhSXRlbSwgc3RyXSwgCiAgICAgICAgICAgICAga2V5cz1Ob25lLCAKICAgICAgICAgICAgICBtZXRyaWNzPU5vbmUsIAogICAgICAgICAgICAgIGxhYmVscz1Ob25lLCAKICAgICAgICAgICAgICBtZXRyaWNfYWdncz1bJ21lYW4nXSwgCiAgICAgICAgICAgICAgbGFiZWxfYWdncz1bJ21heCddLCAKICAgICAgICAgICAgICBzdWZmaXg9Tm9uZSwgCiAgICAgICAgICAgICAgd2luZG93PTMsIAogICAgICAgICAgICAgIGNlbnRlcj1GYWxzZSwgCiAgICAgICAgICAgICAgaW5wbGFjZT1GYWxzZSk6CiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYnQWdncmVnYXRpbmcge2RmX2FydGlmYWN0fScpCiAgICBpbnB1dF9kZiA9IHBkLnJlYWRfcGFycXVldChzdHIoZGZfYXJ0aWZhY3QpKQogICAgCiAgICBpZiBub3QgKG1ldHJpY3Mgb3IgbGFiZWxzKToKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgnZGYnLCBpbnB1dF9kZikKICAgICAgICByZXR1cm4gaW5wdXRfZGYKICAgIAogICAgaWYga2V5czoKICAgICAgICBjdXJyZW50X2luZGV4ID0gaW5wdXRfZGYuaW5kZXgubmFtZXMKICAgICAgICBpbmRleGVzX3RvX2Ryb3AgPSBbY29sIGZvciBjb2wgaW4gaW5wdXRfZGYuaW5kZXgubmFtZXMgaWYgY29sIG5vdCBpbiBrZXlzXQogICAgICAgIGRmID0gaW5wdXRfZGYucmVzZXRfaW5kZXgobGV2ZWw9aW5kZXhlc190b19kcm9wKQogICAgZWxzZToKICAgICAgICBkZiA9IGlucHV0X2RmCiAgICAKICAgIGlmIG1ldHJpY3M6CiAgICAgICAgbWV0cmljc19kZiA9IGRmLmxvY1s6LCBtZXRyaWNzXS5yb2xsaW5nKHdpbmRvdz13aW5kb3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbnRlcj1jZW50ZXIpLmFnZ3JlZ2F0ZShtZXRyaWNfYWdncykKICAgICAgICAKICAgICAgICBtZXRyaWNzX2RmLmNvbHVtbnMgPSBbJ18nLmpvaW4oY29sKS5zdHJpcCgpIGZvciBjb2wgaW4gbWV0cmljc19kZi5jb2x1bW5zLnZhbHVlc10KICAgICAgICAKICAgICAgICBpZiBzdWZmaXg6CiAgICAgICAgICAgIG1ldHJpY3NfZGYuY29sdW1ucyA9IFtmJ3ttZXRyaWN9X3tzdWZmaXh9JyBmb3IgbWV0cmljIGluIG1ldHJpY3NfZGYuY29sdW1uc10KICAgICAgICAgICAgCiAgICAgICAgaWYgbm90IGlucGxhY2U6CiAgICAgICAgICAgIGZpbmFsX2RmID0gcGQubWVyZ2UoaW5wdXRfZGYsIG1ldHJpY3NfZGYsIHN1ZmZpeGVzPSgnJywgc3VmZml4KSwgbGVmdF9pbmRleD1UcnVlLCByaWdodF9pbmRleD1UcnVlKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGZpbmFsX2RmID0gbWV0cmljc19kZgoKICAgIGlmIGxhYmVsczoKICAgICAgICBsYWJlbHNfZGYgPSBkZi5sb2NbOiwgbGFiZWxzXS5yb2xsaW5nKHdpbmRvdz13aW5kb3csCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXI9Y2VudGVyKS5hZ2dyZWdhdGUobGFiZWxfYWdncykKICAgICAgICBsYWJlbHNfZGYuY29sdW1ucyA9IFsnXycuam9pbihjb2wpLnN0cmlwKCkgZm9yIGNvbCBpbiBsYWJlbHNfZGYuY29sdW1ucy52YWx1ZXNdCiAgICAgICAgCiAgICAgICAgaWYgc3VmZml4OgogICAgICAgICAgICBsYWJlbHNfZGYuY29sdW1ucyA9IFtmJ3tsYWJlbH1fe3N1ZmZpeH0nIGZvciBsYWJlbCBpbiBsYWJlbHNfZGYuY29sdW1uc10KICAgICAgICAgICAgCiAgICAgICAgaWYgbWV0cmljczoKICAgICAgICAgICAgZmluYWxfZGYgPSBwZC5tZXJnZShmaW5hbF9kZiwgbGFiZWxzX2RmLCBzdWZmaXhlcz0oJycsIHN1ZmZpeCksIGxlZnRfaW5kZXg9VHJ1ZSwgcmlnaHRfaW5kZXg9VHJ1ZSkgICAKICAgICAgICBlbHNlOgogICAgICAgICAgICBpZiBub3QgaW5wbGFjZToKICAgICAgICAgICAgICAgIGZpbmFsX2RmID0gcGQubWVyZ2UoaW5wdXRfZGYsIGxhYmVsc19kZiwgc3VmZml4ZXM9KCcnLCBzdWZmaXgpLCBsZWZ0X2luZGV4PVRydWUsIHJpZ2h0X2luZGV4PVRydWUpICAgICAgCiAgICAgICAgICAgIGVsc2U6CiAgICAgICAgICAgICAgICBmaW5hbF9kZiA9IGxhYmVsc19kZgogICAgICAgIAogICAgY29udGV4dC5sb2dfZGF0YXNldChrZXk9J2FnZ3JlZ2F0ZScsIAogICAgICAgICAgICAgICAgICAgICAgICBkZj1maW5hbF9kZiwgCiAgICAgICAgICAgICAgICAgICAgICAgIGZvcm1hdD0ncGFycXVldCcpCgo=
    commands: []
    code_origin: https://github.com/mlrun/functions.git#6a5de3e17cd9617899ce149e1e979a13be67d2f9:aggregate.ipynb
