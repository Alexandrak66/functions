kind: job
metadata:
  name: aggregate
  tag: ''
  hash: 5ad8496ed6c6fb915d84637ce175661667f4eaef
  project: ''
  categories:
  - preprocessing
spec:
  command: ''
  args: []
  image: mlrun/ml-models:0.4.6
  env: []
  default_handler: aggregate
  description: Rolling aggregation over Metrics and Lables according to specifications
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTAyIDE2OjQwCgppbXBvcnQgb3MKaW1wb3J0IHBhbmRhcyBhcyBwZAoKZnJvbSB0eXBpbmcgaW1wb3J0IFVuaW9uCmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQoKZGVmIGFnZ3JlZ2F0ZShjb250ZXh0LAogICAgICAgICAgICAgIGRmX2FydGlmYWN0OiBVbmlvbltEYXRhSXRlbSwgc3RyXSwgCiAgICAgICAgICAgICAga2V5cz1Ob25lLCAKICAgICAgICAgICAgICBtZXRyaWNzPU5vbmUsIAogICAgICAgICAgICAgIGxhYmVscz1Ob25lLCAKICAgICAgICAgICAgICBtZXRyaWNfYWdncz1bJ21lYW4nXSwgCiAgICAgICAgICAgICAgbGFiZWxfYWdncz1bJ21heCddLCAKICAgICAgICAgICAgICBzdWZmaXg9Tm9uZSwgCiAgICAgICAgICAgICAgd2luZG93PTMsIAogICAgICAgICAgICAgIGNlbnRlcj1GYWxzZSwgCiAgICAgICAgICAgICAgaW5wbGFjZT1GYWxzZSwKICAgICAgICAgICAgICBzYXZlX3RvPU5vbmUpOgogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmJ0FnZ3JlZ2F0aW5nIHtkZl9hcnRpZmFjdH0nKQogICAgaW5wdXRfZGYgPSBwZC5yZWFkX3BhcnF1ZXQoc3RyKGRmX2FydGlmYWN0KSkKICAgIAogICAgaWYgbm90IChtZXRyaWNzIG9yIGxhYmVscyk6CiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoJ2RmJywgaW5wdXRfZGYpCiAgICAgICAgcmV0dXJuIGlucHV0X2RmCiAgICAKICAgIGlmIGtleXM6CiAgICAgICAgY3VycmVudF9pbmRleCA9IGlucHV0X2RmLmluZGV4Lm5hbWVzCiAgICAgICAgaW5kZXhlc190b19kcm9wID0gW2NvbCBmb3IgY29sIGluIGlucHV0X2RmLmluZGV4Lm5hbWVzIGlmIGNvbCBub3QgaW4ga2V5c10KICAgICAgICBkZiA9IGlucHV0X2RmLnJlc2V0X2luZGV4KGxldmVsPWluZGV4ZXNfdG9fZHJvcCkKICAgIGVsc2U6CiAgICAgICAgZGYgPSBpbnB1dF9kZgogICAgCiAgICBpZiBtZXRyaWNzOgogICAgICAgIG1ldHJpY3NfZGYgPSBkZi5sb2NbOiwgbWV0cmljc10ucm9sbGluZyh3aW5kb3c9d2luZG93LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBjZW50ZXI9Y2VudGVyKS5hZ2dyZWdhdGUobWV0cmljX2FnZ3MpCiAgICAgICAgCiAgICAgICAgbWV0cmljc19kZi5jb2x1bW5zID0gWydfJy5qb2luKGNvbCkuc3RyaXAoKSBmb3IgY29sIGluIG1ldHJpY3NfZGYuY29sdW1ucy52YWx1ZXNdCiAgICAgICAgCiAgICAgICAgaWYgc3VmZml4OgogICAgICAgICAgICBtZXRyaWNzX2RmLmNvbHVtbnMgPSBbZid7bWV0cmljfV97c3VmZml4fScgZm9yIG1ldHJpYyBpbiBtZXRyaWNzX2RmLmNvbHVtbnNdCiAgICAgICAgICAgIAogICAgICAgIGlmIG5vdCBpbnBsYWNlOgogICAgICAgICAgICBmaW5hbF9kZiA9IHBkLm1lcmdlKGlucHV0X2RmLCBtZXRyaWNzX2RmLCBzdWZmaXhlcz0oJycsIHN1ZmZpeCksIGxlZnRfaW5kZXg9VHJ1ZSwgcmlnaHRfaW5kZXg9VHJ1ZSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBmaW5hbF9kZiA9IG1ldHJpY3NfZGYKCiAgICBpZiBsYWJlbHM6CiAgICAgICAgbGFiZWxzX2RmID0gZGYubG9jWzosIGxhYmVsc10ucm9sbGluZyh3aW5kb3c9d2luZG93LAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VudGVyPWNlbnRlcikuYWdncmVnYXRlKGxhYmVsX2FnZ3MpCiAgICAgICAgbGFiZWxzX2RmLmNvbHVtbnMgPSBbJ18nLmpvaW4oY29sKS5zdHJpcCgpIGZvciBjb2wgaW4gbGFiZWxzX2RmLmNvbHVtbnMudmFsdWVzXQogICAgICAgIAogICAgICAgIGlmIHN1ZmZpeDoKICAgICAgICAgICAgbGFiZWxzX2RmLmNvbHVtbnMgPSBbZid7bGFiZWx9X3tzdWZmaXh9JyBmb3IgbGFiZWwgaW4gbGFiZWxzX2RmLmNvbHVtbnNdCiAgICAgICAgICAgIAogICAgICAgIGlmIG1ldHJpY3M6CiAgICAgICAgICAgIGZpbmFsX2RmID0gcGQubWVyZ2UoZmluYWxfZGYsIGxhYmVsc19kZiwgc3VmZml4ZXM9KCcnLCBzdWZmaXgpLCBsZWZ0X2luZGV4PVRydWUsIHJpZ2h0X2luZGV4PVRydWUpICAgCiAgICAgICAgZWxzZToKICAgICAgICAgICAgaWYgbm90IGlucGxhY2U6CiAgICAgICAgICAgICAgICBmaW5hbF9kZiA9IHBkLm1lcmdlKGlucHV0X2RmLCBsYWJlbHNfZGYsIHN1ZmZpeGVzPSgnJywgc3VmZml4KSwgbGVmdF9pbmRleD1UcnVlLCByaWdodF9pbmRleD1UcnVlKSAgICAgIAogICAgICAgICAgICBlbHNlOgogICAgICAgICAgICAgICAgZmluYWxfZGYgPSBsYWJlbHNfZGYKICAgICAgICAKICAgIGNvbnRleHQubG9nX2RhdGFzZXQoa2V5PSdhZ2dyZWdhdGUnLCAKICAgICAgICAgICAgICAgICAgICAgICAgZGY9ZmluYWxfZGYsIAogICAgICAgICAgICAgICAgICAgICAgICBmb3JtYXQ9J3BhcnF1ZXQnLAogICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPXNhdmVfdG8pCgo=
    commands: []
    code_origin: https://github.com/mlrun/functions.git#d92dddc769536b33d49e5f7451f4cd9310fc460d:aggregate.ipynb
