kind: job
metadata:
  name: aggregate
  tag: ''
  hash: c16effd83e20ec99af29b165fe18f5e7f3e8594b
  project: ''
  labels:
    author: orz
  categories:
  - data-prep
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: aggregate
  entry_points:
    aggregate:
      name: aggregate
      doc: Time-series aggregation function
      parameters:
      - name: context
      - name: df_artifact
        type: DataItem
      - name: save_to
        type: str
        default: aggregated-df.pq
      - name: keys
        type: list
      - name: metrics
        type: list
      - name: labels
        type: list
      - name: metric_aggs
        type: list
        default:
        - mean
      - name: label_aggs
        type: list
        default:
        - max
      - name: suffix
        type: str
      - name: window
        type: int
        default: 3
      - name: center
        type: bool
      - name: inplace
        type: bool
      outputs: []
      lineno: 7
  description: Rolling aggregation over Metrics and Lables according to specifications
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA1LTAxIDIwOjUwCgppbXBvcnQgb3MKaW1wb3J0IHBhbmRhcyBhcyBwZApmcm9tIG1scnVuLmRhdGFzdG9yZSBpbXBvcnQgRGF0YUl0ZW0KCmRlZiBhZ2dyZWdhdGUoY29udGV4dCwKICAgICAgICAgICAgICBkZl9hcnRpZmFjdDogRGF0YUl0ZW0sCiAgICAgICAgICAgICAgc2F2ZV90bzogc3RyID0gJ2FnZ3JlZ2F0ZWQtZGYucHEnLCAKICAgICAgICAgICAgICBrZXlzOiBsaXN0ID0gTm9uZSwgCiAgICAgICAgICAgICAgbWV0cmljczogbGlzdCA9IE5vbmUsIAogICAgICAgICAgICAgIGxhYmVsczogbGlzdCA9IE5vbmUsIAogICAgICAgICAgICAgIG1ldHJpY19hZ2dzOiBsaXN0ID0gWydtZWFuJ10sIAogICAgICAgICAgICAgIGxhYmVsX2FnZ3M6IGxpc3QgPSBbJ21heCddLCAKICAgICAgICAgICAgICBzdWZmaXg6IHN0ciA9IE5vbmUsIAogICAgICAgICAgICAgIHdpbmRvdzogaW50ID0gMywgCiAgICAgICAgICAgICAgY2VudGVyOiBib29sID0gRmFsc2UsIAogICAgICAgICAgICAgIGlucGxhY2U6IGJvb2wgPSBGYWxzZSk6CiAgICAiIiJUaW1lLXNlcmllcyBhZ2dyZWdhdGlvbiBmdW5jdGlvbiIiIgogICAgCiAgICAKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZidBZ2dyZWdhdGluZyB7ZGZfYXJ0aWZhY3QudXJsfScpCiAgICBpbnB1dF9kZiA9IGRmX2FydGlmYWN0LmFzX2RmKCkKICAgIAogICAgaWYgbm90IChtZXRyaWNzIG9yIGxhYmVscyk6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcigncGxlYXNlIHNwZWNpZnkgbWV0cmljcyBvciBsYWJlbHMgcGFyYW0nKQogICAgCiAgICBpZiBrZXlzOgogICAgICAgIGN1cnJlbnRfaW5kZXggPSBpbnB1dF9kZi5pbmRleC5uYW1lcwogICAgICAgIGluZGV4ZXNfdG9fZHJvcCA9IFtjb2wgZm9yIGNvbCBpbiBpbnB1dF9kZi5pbmRleC5uYW1lcyBpZiBjb2wgbm90IGluIGtleXNdCiAgICAgICAgZGYgPSBpbnB1dF9kZi5yZXNldF9pbmRleChsZXZlbD1pbmRleGVzX3RvX2Ryb3ApCiAgICBlbHNlOgogICAgICAgIGRmID0gaW5wdXRfZGYKICAgIAogICAgaWYgbWV0cmljczoKICAgICAgICBtZXRyaWNzX2RmID0gZGYubG9jWzosIG1ldHJpY3NdLnJvbGxpbmcod2luZG93PXdpbmRvdywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgY2VudGVyPWNlbnRlcikuYWdncmVnYXRlKG1ldHJpY19hZ2dzKQogICAgICAgIAogICAgICAgIG1ldHJpY3NfZGYuY29sdW1ucyA9IFsnXycuam9pbihjb2wpLnN0cmlwKCkgZm9yIGNvbCBpbiBtZXRyaWNzX2RmLmNvbHVtbnMudmFsdWVzXQogICAgICAgIAogICAgICAgIGlmIHN1ZmZpeDoKICAgICAgICAgICAgbWV0cmljc19kZi5jb2x1bW5zID0gW2Yne21ldHJpY31fe3N1ZmZpeH0nIGZvciBtZXRyaWMgaW4gbWV0cmljc19kZi5jb2x1bW5zXQogICAgICAgICAgICAKICAgICAgICBpZiBub3QgaW5wbGFjZToKICAgICAgICAgICAgZmluYWxfZGYgPSBwZC5tZXJnZShpbnB1dF9kZiwgbWV0cmljc19kZiwgc3VmZml4ZXM9KCcnLCBzdWZmaXgpLCBsZWZ0X2luZGV4PVRydWUsIHJpZ2h0X2luZGV4PVRydWUpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgZmluYWxfZGYgPSBtZXRyaWNzX2RmCgogICAgaWYgbGFiZWxzOgogICAgICAgIGxhYmVsc19kZiA9IGRmLmxvY1s6LCBsYWJlbHNdLnJvbGxpbmcod2luZG93PXdpbmRvdywKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGNlbnRlcj1jZW50ZXIpLmFnZ3JlZ2F0ZShsYWJlbF9hZ2dzKQogICAgICAgIGxhYmVsc19kZi5jb2x1bW5zID0gWydfJy5qb2luKGNvbCkuc3RyaXAoKSBmb3IgY29sIGluIGxhYmVsc19kZi5jb2x1bW5zLnZhbHVlc10KICAgICAgICAKICAgICAgICBpZiBzdWZmaXg6CiAgICAgICAgICAgIGxhYmVsc19kZi5jb2x1bW5zID0gW2Yne2xhYmVsfV97c3VmZml4fScgZm9yIGxhYmVsIGluIGxhYmVsc19kZi5jb2x1bW5zXQogICAgICAgICAgICAKICAgICAgICBpZiBtZXRyaWNzOgogICAgICAgICAgICBmaW5hbF9kZiA9IHBkLm1lcmdlKGZpbmFsX2RmLCBsYWJlbHNfZGYsIHN1ZmZpeGVzPSgnJywgc3VmZml4KSwgbGVmdF9pbmRleD1UcnVlLCByaWdodF9pbmRleD1UcnVlKSAgIAogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGlmIG5vdCBpbnBsYWNlOgogICAgICAgICAgICAgICAgZmluYWxfZGYgPSBwZC5tZXJnZShpbnB1dF9kZiwgbGFiZWxzX2RmLCBzdWZmaXhlcz0oJycsIHN1ZmZpeCksIGxlZnRfaW5kZXg9VHJ1ZSwgcmlnaHRfaW5kZXg9VHJ1ZSkgICAgICAKICAgICAgICAgICAgZWxzZToKICAgICAgICAgICAgICAgIGZpbmFsX2RmID0gbGFiZWxzX2RmCiAgICAgICAgCiAgICBjb250ZXh0LmxvZ19kYXRhc2V0KGtleT0nYWdncmVnYXRlJywgCiAgICAgICAgICAgICAgICAgICAgICAgIGRmPWZpbmFsX2RmLCAKICAgICAgICAgICAgICAgICAgICAgICAgZm9ybWF0PSdwYXJxdWV0JywKICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxfcGF0aD1zYXZlX3RvKQoK
    commands: []
    code_origin: https://github.com/mlrun/functions.git#7c5bf4405336152a931fea1a4887d10cfd3ad40f:aggregate.ipynb
