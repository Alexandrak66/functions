kind: job
metadata:
  name: test-classifier
  tag: latest
  hash: eebc6431a9af25a084ca4ea72c32d91035099356
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - testing
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: test_classifier
  entry_points:
    _gcf_clear:
      name: _gcf_clear
      doc: ''
      parameters:
      - name: plt
      outputs: []
      lineno: 26
    test_classifier:
      name: test_classifier
      doc: "Test one or more classifier models against held-out dataset\n\nUsing held-out\
        \ test features, evaluates the peformance of the estimated model\n\nCan be\
        \ part of a kubeflow pipeline as a test step that is run post EDA and \ntraining/validation\
        \ cycles"
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: models_dir
        type: str
        doc: artifact models representing a folder or a folder
      - name: test_set
        type: str
        doc: test features and labels
      - name: label_column
        type: str
        doc: column name for ground truth labels
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: key
        type: str
        doc: key for results artifacts (dir and prefix used with artifacts)
      - name: plots_dest
        type: str
        doc: dir for test plots
      outputs: []
      lineno: 31
    key_pfx:
      name: key_pfx
      doc: ''
      parameters:
      - name: artifact
      outputs: []
      lineno: 62
    _eval_model:
      name: _eval_model
      doc: ''
      parameters:
      - name: model
      outputs: []
      lineno: 67
  description: test a classifier using held-out or new data
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI5IDA4OjIzCgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IGltcG9ydGxpYgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBsb2FkCgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZAoKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdApmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IGxhYmVsX2JpbmFyaXplCmZyb20gc2tsZWFybi51dGlscy5tdWx0aWNsYXNzIGltcG9ydCB1bmlxdWVfbGFiZWxzCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBUYWJsZUFydGlmYWN0LCBQbG90QXJ0aWZhY3QKCmZyb20gbWx1dGlscy5tb2RlbHMgaW1wb3J0IGdldF9tb2RlbF9jb25maWdzCmZyb20gbWx1dGlscy5wbG90cyBpbXBvcnQgcGxvdF9yb2MsIHBsb3RfaW1wb3J0YW5jZSwgZ2NmX2NsZWFyCgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiBfZ2NmX2NsZWFyKHBsdCk6CiAgICBwbHQuY2xhKCkKICAgIHBsdC5jbGYoKQogICAgcGx0LmNsb3NlKCkgICAgICAgIAoKZGVmIHRlc3RfY2xhc3NpZmllcigKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxzX2Rpcjogc3RyLCAKICAgIHRlc3Rfc2V0OiBzdHIsCiAgICBsYWJlbF9jb2x1bW46IHN0ciwKICAgIHNjb3JlX21ldGhvZDogc3RyID0gJ21pY3JvJywKICAgIGtleTogc3RyID0gIiIsCiAgICBwbG90c19kZXN0OiBzdHIgPSAiIgopIC0+IE5vbmU6CiAgICAiIiJUZXN0IG9uZSBvciBtb3JlIGNsYXNzaWZpZXIgbW9kZWxzIGFnYWluc3QgaGVsZC1vdXQgZGF0YXNldAogICAgCiAgICBVc2luZyBoZWxkLW91dCB0ZXN0IGZlYXR1cmVzLCBldmFsdWF0ZXMgdGhlIHBlZm9ybWFuY2Ugb2YgdGhlIGVzdGltYXRlZCBtb2RlbAogICAgCiAgICBDYW4gYmUgcGFydCBvZiBhIGt1YmVmbG93IHBpcGVsaW5lIGFzIGEgdGVzdCBzdGVwIHRoYXQgaXMgcnVuIHBvc3QgRURBIGFuZCAKICAgIHRyYWluaW5nL3ZhbGlkYXRpb24gY3ljbGVzCiAgICAKICAgIDpwYXJhbSBjb250ZXh0OiAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxzX2RpcjogICAgICBhcnRpZmFjdCBtb2RlbHMgcmVwcmVzZW50aW5nIGEgZm9sZGVyIG9yIGEgZm9sZGVyCiAgICA6cGFyYW0gdGVzdF9zZXQ6ICAgICAgICB0ZXN0IGZlYXR1cmVzIGFuZCBsYWJlbHMKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgIGNvbHVtbiBuYW1lIGZvciBncm91bmQgdHJ1dGggbGFiZWxzCiAgICA6cGFyYW0gc2NvcmVfbWV0aG9kOiAgICBmb3IgbXVsdGljbGFzcyBjbGFzc2lmaWNhdGlvbgogICAgOnBhcmFtIGtleTogICAgICAgICAgICAga2V5IGZvciByZXN1bHRzIGFydGlmYWN0cyAoZGlyIGFuZCBwcmVmaXggdXNlZCB3aXRoIGFydGlmYWN0cykKICAgIDpwYXJhbSBwbG90c19kZXN0OiAgICAgICBkaXIgZm9yIHRlc3QgcGxvdHMKICAgICIiIgogICAgeHRlc3QgPSBwZC5yZWFkX3BhcnF1ZXQoc3RyKHRlc3Rfc2V0KSkKICAgIHl0ZXN0ID0geHRlc3QucG9wKGxhYmVsX2NvbHVtbikKICAgIAogICAgY29udGV4dC5oZWFkZXIgPSBsaXN0KHh0ZXN0LmNvbHVtbnMudmFsdWVzKQogICAgaWYgbm90IHBsb3RzX2Rlc3Q6CiAgICAgICAgcGxvdHNfZGVzdCA9IGYncGxvdHMve2tleX0nIGlmIGtleSBlbHNlICdwbG90cycKICAgIAogICAgZGVmIGtleV9wZngoYXJ0aWZhY3QpOgogICAgICAgIGlmIGtleToKICAgICAgICAgICAgcmV0dXJuIGYne2tleX1fe2FydGlmYWN0fScKICAgICAgICByZXR1cm4gYXJ0aWZhY3QKICAgIAogICAgZGVmIF9ldmFsX21vZGVsKG1vZGVsKToKICAgICAgICB5dGVzdGIgPSBsYWJlbF9iaW5hcml6ZSh5dGVzdCwgY2xhc3Nlcz15dGVzdC51bmlxdWUoKSkKICAgICAgICBjbGYgPSBsb2FkKG9wZW4obW9kZWwsICJyYiIpKQogICAgICAgIGlmIGNhbGxhYmxlKGdldGF0dHIoY2xmLCAicHJlZGljdF9wcm9iYSIpKToKICAgICAgICAgICAgeV9zY29yZSA9IGNsZi5wcmVkaWN0X3Byb2JhKHh0ZXN0LnZhbHVlcykKICAgICAgICAgICAgeXByZWQgPSBjbGYucHJlZGljdCh4dGVzdC52YWx1ZXMpCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5X3Njb3JlLnNoYXBlIHt5X3Njb3JlLnNoYXBlfSIpCiAgICAgICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5dGVzdGIuc2hhcGUge3l0ZXN0Yi5zaGFwZX0iKQogICAgICAgICAgICBwbG90X3JvYyhjb250ZXh0LCB5dGVzdGIsIHlfc2NvcmUsIGtleT1rZXlfcGZ4KCJyb2MiKSwgcGxvdHNfZGlyPXBsb3RzX2Rlc3QpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgeXByZWQgPSBjbGYucHJlZGljdCh4dGVzdC52YWx1ZXMpICMgcmVmYWN0b3IKICAgICAgICAgICAgeV9zY29yZSA9IE5vbmUKICAgICAgICAgICAgCiAgICAgICAgZ2NmX2NsZWFyKHBsdCkKICAgICAgIAogICAgICAgIG1ldHJpY3MucGxvdF9jb25mdXNpb25fbWF0cml4KGNsZiwgeHRlc3QsIHl0ZXN0LCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsYWJlbHM9eXRlc3QudW5pcXVlKCksIG5vcm1hbGl6ZT0ndHJ1ZScpIAogICAgICAgIAogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdChrZXlfcGZ4KCJjb25mdXNpb24iKSwgYm9keT1wbHQuZ2NmKCkpLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L2NvbmZ1c2lvbi5odG1sIikgICAgICAgIAogICAgCiAgICAgICAgaWYgaGFzYXR0cihjbGYsICJmZWF0dXJlX2ltcG9ydGFuY2VzXyIpOgogICAgICAgICAgICBwbG90X2ltcG9ydGFuY2UoY29udGV4dCwgY2xmLCBrZXk9ZiJmZWF0aW1wIikKCiAgICAgICAgeXRlc3RiID0gbGFiZWxfYmluYXJpemUoeXRlc3QsIGNsYXNzZXM9eXRlc3QudW5pcXVlKCkpICMgaWYgYmluYXJ5IDAvMSBsYWJlbHMsIHdpbGwgcmV0dXJuIGxhYmVscyBhcyBpcwogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5X3Njb3JlLnNoYXBlIHt5X3Njb3JlLnNoYXBlfSIpCiAgICAgICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInl2YWxpZGIuc2hhcGUge3l0ZXN0Yi5zaGFwZX0iKQogICAgICAgIGlmIHl0ZXN0Yi5zaGFwZVsxXSA+IDE6CiAgICAgICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dGVzdGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5X3Njb3JlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpCiAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dGVzdGIsIHlfc2NvcmUpKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dGVzdGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5X3Njb3JlWzosIDFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpCiAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dGVzdGIsIHlfc2NvcmVbOiwgMV0pKQoKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhdmdfcHJlY3Njb3JlIiwgYXZlcmFnZV9wcmVjaXNpb24pCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiYWNjdXJhY3kiLCBmbG9hdChjbGYuc2NvcmUoeHRlc3QsIHl0ZXN0KSkpCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiZjFfc2NvcmUiLCBtZXRyaWNzLmYxX3Njb3JlKHl0ZXN0LCB5cHJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpKQoKICAgIGZvciBtb2RlbCBpbiBvcy5saXN0ZGlyKHN0cihtb2RlbHNfZGlyKSk6CiAgICAgICAgaWYgbW9kZWwuZW5kc3dpdGgoJy5wa2wnKToKICAgICAgICAgICAgX2V2YWxfbW9kZWwob3MucGF0aC5qb2luKHN0cihtb2RlbHNfZGlyKSwgbW9kZWwpKQogICAgICAgICAgICBiZXN0X21vZGVsID0gbW9kZWwKCg==
    commands: []
    code_origin: https://github.com/mlrun/functions.git#713fa39d9974ad6ed9aabc155d4bdf7ff9a39a3a:test_classifier.ipynb
