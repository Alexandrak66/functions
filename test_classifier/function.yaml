kind: job
metadata:
  name: test-classifier
  tag: latest
  hash: 91fe8fbbbc785a5c1de4efbdd6f7ac382c2bf3ea
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - testing
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: test_classifier
  entry_points:
    _gcf_clear:
      name: _gcf_clear
      doc: ''
      parameters:
      - name: plt
      outputs: []
      lineno: 26
    test_classifier:
      name: test_classifier
      doc: "Test one or more classifier models against held-out dataset\n\nUsing held-out\
        \ test features, evaluates the peformance of the estimated model\n\nCan be\
        \ part of a kubeflow pipeline as a test step that is run post EDA and \ntraining/validation\
        \ cycles"
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: models_dir
        type: str
        doc: artifact models representing a folder or a folder
      - name: test_set
        type: str
        doc: test features and labels
      - name: label_column
        type: str
        doc: column name for ground truth labels
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: plots_dest
        type: str
        doc: dir for test plots
      outputs: []
      lineno: 31
    _eval_model:
      name: _eval_model
      doc: ''
      parameters:
      - name: model
      outputs: []
      lineno: 57
  description: test a classifier using held-out or new data
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI5IDExOjUwCgppbXBvcnQgb3MKaW1wb3J0IGpzb24KaW1wb3J0IGltcG9ydGxpYgpmcm9tIGNsb3VkcGlja2xlIGltcG9ydCBsb2FkCgppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IHBhbmRhcyBhcyBwZAoKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdApmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IGxhYmVsX2JpbmFyaXplCmZyb20gc2tsZWFybi51dGlscy5tdWx0aWNsYXNzIGltcG9ydCB1bmlxdWVfbGFiZWxzCgpmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBUYWJsZUFydGlmYWN0LCBQbG90QXJ0aWZhY3QKCmZyb20gbWx1dGlscy5tb2RlbHMgaW1wb3J0IGdldF9tb2RlbF9jb25maWdzCmZyb20gbWx1dGlscy5wbG90cyBpbXBvcnQgcGxvdF9yb2MsIHBsb3RfaW1wb3J0YW5jZSwgZ2NmX2NsZWFyCgppbXBvcnQgd2FybmluZ3MKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiBfZ2NmX2NsZWFyKHBsdCk6CiAgICBwbHQuY2xhKCkKICAgIHBsdC5jbGYoKQogICAgcGx0LmNsb3NlKCkgICAgICAgIAoKZGVmIHRlc3RfY2xhc3NpZmllcigKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxzX2Rpcjogc3RyLCAKICAgIHRlc3Rfc2V0OiBzdHIsCiAgICBsYWJlbF9jb2x1bW46IHN0ciwKICAgIHNjb3JlX21ldGhvZDogc3RyID0gJ21pY3JvJywKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICIiCikgLT4gTm9uZToKICAgICIiIlRlc3Qgb25lIG9yIG1vcmUgY2xhc3NpZmllciBtb2RlbHMgYWdhaW5zdCBoZWxkLW91dCBkYXRhc2V0CiAgICAKICAgIFVzaW5nIGhlbGQtb3V0IHRlc3QgZmVhdHVyZXMsIGV2YWx1YXRlcyB0aGUgcGVmb3JtYW5jZSBvZiB0aGUgZXN0aW1hdGVkIG1vZGVsCiAgICAKICAgIENhbiBiZSBwYXJ0IG9mIGEga3ViZWZsb3cgcGlwZWxpbmUgYXMgYSB0ZXN0IHN0ZXAgdGhhdCBpcyBydW4gcG9zdCBFREEgYW5kIAogICAgdHJhaW5pbmcvdmFsaWRhdGlvbiBjeWNsZXMKICAgIAogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgdGhlIGZ1bmN0aW9uIGNvbnRleHQKICAgIDpwYXJhbSBtb2RlbHNfZGlyOiAgICAgIGFydGlmYWN0IG1vZGVscyByZXByZXNlbnRpbmcgYSBmb2xkZXIgb3IgYSBmb2xkZXIKICAgIDpwYXJhbSB0ZXN0X3NldDogICAgICAgIHRlc3QgZmVhdHVyZXMgYW5kIGxhYmVscwogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgY29sdW1uIG5hbWUgZm9yIGdyb3VuZCB0cnV0aCBsYWJlbHMKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgIGZvciBtdWx0aWNsYXNzIGNsYXNzaWZpY2F0aW9uCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgZGlyIGZvciB0ZXN0IHBsb3RzCiAgICAiIiIKICAgIHh0ZXN0ID0gcGQucmVhZF9wYXJxdWV0KHN0cih0ZXN0X3NldCkpCiAgICB5dGVzdCA9IHh0ZXN0LnBvcChsYWJlbF9jb2x1bW4pCiAgICAKICAgIGNvbnRleHQuaGVhZGVyID0gbGlzdCh4dGVzdC5jb2x1bW5zLnZhbHVlcykKICAgIGRlZiBfZXZhbF9tb2RlbChtb2RlbCk6CiAgICAgICAgeXRlc3RiID0gbGFiZWxfYmluYXJpemUoeXRlc3QsIGNsYXNzZXM9eXRlc3QudW5pcXVlKCkpCiAgICAgICAgY2xmID0gbG9hZChvcGVuKG1vZGVsLCAicmIiKSkKICAgICAgICBpZiBjYWxsYWJsZShnZXRhdHRyKGNsZiwgInByZWRpY3RfcHJvYmEiKSk6CiAgICAgICAgICAgIHlfc2NvcmUgPSBjbGYucHJlZGljdF9wcm9iYSh4dGVzdC52YWx1ZXMpCiAgICAgICAgICAgIHlwcmVkID0gY2xmLnByZWRpY3QoeHRlc3QudmFsdWVzKQogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieV9zY29yZS5zaGFwZSB7eV9zY29yZS5zaGFwZX0iKQogICAgICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieXRlc3RiLnNoYXBlIHt5dGVzdGIuc2hhcGV9IikKICAgICAgICAgICAgcGxvdF9yb2MoY29udGV4dCwgeXRlc3RiLCB5X3Njb3JlLCBrZXk9J3JvYycsIHBsb3RzX2Rpcj1wbG90c19kZXN0KQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHlwcmVkID0gY2xmLnByZWRpY3QoeHRlc3QudmFsdWVzKSAjIHJlZmFjdG9yCiAgICAgICAgICAgIHlfc2NvcmUgPSBOb25lCiAgICAgICAgICAgIAogICAgICAgIGdjZl9jbGVhcihwbHQpCiAgICAgICAKICAgICAgICBtZXRyaWNzLnBsb3RfY29uZnVzaW9uX21hdHJpeChjbGYsIHh0ZXN0LCB5dGVzdCwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbGFiZWxzPXl0ZXN0LnVuaXF1ZSgpLCBub3JtYWxpemU9J3RydWUnKSAKICAgICAgICAKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QoImNvbmZ1c2lvbiIsIGJvZHk9cGx0LmdjZigpKSwgCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgbG9jYWxfcGF0aD1mIntwbG90c19kZXN0fS9jb25mdXNpb24uaHRtbCIpICAgICAgICAKICAgIAogICAgICAgIGlmIGhhc2F0dHIoY2xmLCAiZmVhdHVyZV9pbXBvcnRhbmNlc18iKToKICAgICAgICAgICAgcGxvdF9pbXBvcnRhbmNlKGNvbnRleHQsIGNsZiwga2V5PWYiZmVhdGltcCIpCgogICAgICAgIHl0ZXN0YiA9IGxhYmVsX2JpbmFyaXplKHl0ZXN0LCBjbGFzc2VzPXl0ZXN0LnVuaXF1ZSgpKSAjIGlmIGJpbmFyeSAwLzEgbGFiZWxzLCB3aWxsIHJldHVybiBsYWJlbHMgYXMgaXMKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieV9zY29yZS5zaGFwZSB7eV9zY29yZS5zaGFwZX0iKQogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5dmFsaWRiLnNoYXBlIHt5dGVzdGIuc2hhcGV9IikKICAgICAgICBpZiB5dGVzdGIuc2hhcGVbMV0gPiAxOgogICAgICAgICAgICBhdmVyYWdlX3ByZWNpc2lvbiA9IG1ldHJpY3MuYXZlcmFnZV9wcmVjaXNpb25fc2NvcmUoeXRlc3RiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXRlc3RiLCB5X3Njb3JlKSkKICAgICAgICBlbHNlOgogICAgICAgICAgICBhdmVyYWdlX3ByZWNpc2lvbiA9IG1ldHJpY3MuYXZlcmFnZV9wcmVjaXNpb25fc2NvcmUoeXRlc3RiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZVs6LCAxXSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXRlc3RiLCB5X3Njb3JlWzosIDFdKSkKCiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiYXZnX3ByZWNzY29yZSIsIGF2ZXJhZ2VfcHJlY2lzaW9uKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImFjY3VyYWN5IiwgZmxvYXQoY2xmLnNjb3JlKHh0ZXN0LCB5dGVzdCkpKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZSh5dGVzdCwgeXByZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKCiAgICBmb3IgbW9kZWwgaW4gb3MubGlzdGRpcihzdHIobW9kZWxzX2RpcikpOgogICAgICAgIGlmIG1vZGVsLmVuZHN3aXRoKCcucGtsJyk6CiAgICAgICAgICAgIF9ldmFsX21vZGVsKG9zLnBhdGguam9pbihzdHIobW9kZWxzX2RpciksIG1vZGVsKSkKICAgICAgICAgICAgYmVzdF9tb2RlbCA9IG1vZGVsCgo=
    commands: []
    code_origin: https://github.com/mlrun/functions.git#1d3c408934cac094180bd199a76881baf0832fbd:test_classifier.ipynb
