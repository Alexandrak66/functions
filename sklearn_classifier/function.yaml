kind: job
metadata:
  name: sklearn-classifier
  tag: latest
  hash: 41b09e93ba95846777305ac9d1d0371a76438944
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7fa59b587cf8>
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: model_pkg_file
        type: str
        doc: json model config file
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      outputs: []
      lineno: 28
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTMxIDA5OjQyCgppbXBvcnQganNvbgppbXBvcnQgb3MKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzLCBsb2FkCgpmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAppbXBvcnQgc2VhYm9ybiBhcyBzbnMKCmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBsYWJlbF9iaW5hcml6ZQpmcm9tIHNrbGVhcm4ubW9kZWxfc2VsZWN0aW9uIGltcG9ydCB0cmFpbl90ZXN0X3NwbGl0CmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwoKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0CmZyb20gbWxydW4ubWx1dGlscyBpbXBvcnQgZ2V0X2NsYXNzX2ZpdCwgY3JlYXRlX2NsYXNzLCBwbG90X3JvYywgcGxvdF9pbXBvcnRhbmNlLCBnY2ZfY2xlYXIKCmltcG9ydCB3YXJuaW5ncwoKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIgPSAiIiwKICAgIGRhdGFzZXQ6IERhdGFJdGVtID0gTm9uZSwKICAgIHNhbXBsZTogaW50ID0gLTEsCiAgICBsYWJlbF9jb2x1bW46IHN0ciA9ICJsYWJlbHMiLAogICAgdGVzdF9zaXplOiBmbG9hdCA9IDAuMDUsCiAgICB0cmFpbl92YWxfc3BsaXQ6IGZsb2F0ID0gMC43NSwKICAgIHJuZzogaW50ID0gMSwKICAgIG1vZGVsX2ZpbGVuYW1lOiBzdHIgPSAibW9kZWwiLAogICAgbW9kZWxzX2Rlc3Q6IHN0ciA9ICIiLAogICAgcGxvdHNfZGVzdDogc3RyID0gIiIsCiAgICBzY29yZV9tZXRob2Q6IHN0ciA9ICJtaWNybyIsCiAgICBtb2RlbF9wa2dfZmlsZTogc3RyID0gIiIsCiAgICBmaWxlX2V4dDogc3RyID0gInBhcnF1ZXQiCikgLT4gTm9uZToKICAgICIiInRyYWluIGEgY2xhc3NpZmllci4KCiAgICA6cGFyYW0gY29udGV4dDogICAgICAgICAgIHRoZSBmdW5jdGlvbiBjb250ZXh0CiAgICA6cGFyYW0gbW9kZWxfcGtnX2NsYXNzOiAgIHRoZSBtb2RlbCB0byB0cmFpbiwgZS5nLCAic2tsZWFybi5uZXVyYWxfbmV0d29ya3MuTUxQQ2xhc3NpZmllciIsIAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBvciBqc29uIG1vZGVsIGNvbmZpZwogICAgOnBhcmFtIGRhdGFzZXQ6ICAgICAgICAgICAoImRhdGEiKSBuYW1lIG9mIHJhdyBkYXRhIGZpbGUKICAgIDpwYXJhbSBzYW1wbGU6ICAgICAgICAgICAgU2VsZWN0cyB0aGUgZmlyc3QgbiByb3dzLCBvciBzZWxlY3QgYSBzYW1wbGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgc3RhcnRpbmcgZnJvbSB0aGUgZmlyc3QuIElmIG5lZ2F0aXZlIDwtMSwgc2VsZWN0CiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGEgcmFuZG9tIHNhbXBsZQogICAgOnBhcmFtIGxhYmVsX2NvbHVtbjogICAgICBncm91bmQtdHJ1dGggKHkpIGxhYmVscwogICAgOnBhcmFtIG1vZGVsX2ZpbGVuYW1lOiAgICBtb2RlbCBmaWxlIGZpbGVuYW1lLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBwb2ludHMgdG8gYSBkaXJlY3RvcnkKICAgIDpwYXJhbSB0ZXN0X3NpemU6ICAgICAgICAgKDAuMDUpIHRlc3Qgc2V0IHNpemUKICAgIDpwYXJhbSB0cmFpbl92YWxfc3BsaXQ6ICAgKDAuNzUpIE9uY2UgdGhlIHRlc3Qgc2V0IGhhcyBiZWVuIHJlbW92ZWQgdGhlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHRyYWluaW5nIHNldCBnZXRzIHRoaXMgcHJvcG9ydGlvbi4KICAgIDpwYXJhbSBybmc6ICAgICAgICAgICAgICAgKDEpIHNrbGVhcm4gcm5nIHNlZWQKICAgIDpwYXJhbSBtb2RlbHNfZGVzdDogICAgICAgbW9kZWxzIHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgIHBsb3Qgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgICAgZm9yIG11bHRpY2xhc3MgY2xhc3NpZmljYXRpb24KICAgIDpwYXJhbSBtb2RlbF9wa2dfZmlsZTogICAganNvbiBtb2RlbCBjb25maWcgZmlsZQogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICAiIiIKICAgIHNyY2ZpbGVwYXRoID0gc3RyKGRhdGFzZXQpCiAgICAKICAgIG1vZGVsc19kZXN0ID0gbW9kZWxzX2Rlc3Qgb3IgJ21vZGVscycKICAgIHBsb3RzX2Rlc3QgPSBwbG90c19kZXN0IG9yIGYncGxvdHMve2NvbnRleHQubmFtZX0nCiAgICAKICAgIGlmIChzYW1wbGUgPT0gLTEpIG9yIChzYW1wbGUgPj0gMSk6CiAgICAgICAgaWYgc3JjZmlsZXBhdGguZW5kc3dpdGgoIi5jc3YiKToKICAgICAgICAgICAgcmF3ID0gcGQucmVhZF9jc3Yoc3JjZmlsZXBhdGgpLmRyb3BuYSgpCiAgICAgICAgaWYgc3JjZmlsZXBhdGguZW5kc3dpdGgoInBhcnF1ZXQiKSBvciBzcmNmaWxlcGF0aC5lbmRzd2l0aCgicHEiKToKICAgICAgICAgICAgcmF3ID0gcGQucmVhZF9wYXJxdWV0KHNyY2ZpbGVwYXRoKS5kcm9wbmEoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbigiZmlsZSB0eXBlIHVuaGFuZGxlZCIpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCiAgICAgICAgcmF3ID0gcmF3Lmlsb2NbOnNhbXBsZSwgOl0KICAgICAgICBsYWJlbHMgPSBsYWJlbHMuaWxvY1s6c2FtcGxlXQogICAgZWxzZToKICAgICAgICByYXcgPSBwcS5yZWFkX3RhYmxlKHNyY2ZpbGVwYXRoKS50b19wYW5kYXMoKS5kcm9wbmEoKS5zYW1wbGUoc2FtcGxlICogLTEpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCgogICAgY29udGV4dC5oZWFkZXIgPSByYXcuY29sdW1ucy52YWx1ZXMKICAgIAogICAgeWIgPSBsYWJlbF9iaW5hcml6ZShsYWJlbHMsIGNsYXNzZXM9bGFiZWxzLnVuaXF1ZSgpKSAjIGlmIGJpbmFyeSAwLzEgbGFiZWxzLCB3aWxsIHJldHVybiBsYWJlbHMgYXMgaXMKICAgIAogICAgeCwgeHRlc3QsIHksIHl0ZXN0ID0gdHJhaW5fdGVzdF9zcGxpdChucC5jb25jYXRlbmF0ZShbcmF3LCB5Yl0sIGF4aXM9MSksIGxhYmVscywgdGVzdF9zaXplPXRlc3Rfc2l6ZSwgcmFuZG9tX3N0YXRlPXJuZykKICAgIHh0cmFpbiwgeHZhbGlkLCB5dHJhaW4sIHl2YWxpZCA9IHRyYWluX3Rlc3Rfc3BsaXQoeCwgeSwgdHJhaW5fc2l6ZT10cmFpbl92YWxfc3BsaXQsIHJhbmRvbV9zdGF0ZT1ybmcpCiAgICB5dHJhaW5iID0geHRyYWluWzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHRyYWluID0geHRyYWluWzosIDoteWIuc2hhcGVbMV1dLmNvcHkoKQogICAgeXZhbGlkYiA9IHh2YWxpZFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh2YWxpZCA9IHh2YWxpZFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkKICAgIHl0ZXN0YiA9IHh0ZXN0WzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHRlc3QgPSB4dGVzdFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgCiAgICB0ZXN0X3NldCA9IHBkLmNvbmNhdCgKICAgICAgICBbcGQuRGF0YUZyYW1lKGRhdGE9eHRlc3QsIGNvbHVtbnM9Y29udGV4dC5oZWFkZXIpLAogICAgICAgICBwZC5EYXRhRnJhbWUoZGF0YT15dGVzdC52YWx1ZXMsIGNvbHVtbnM9W2xhYmVsX2NvbHVtbl0pXSwKICAgICAgICBheGlzPTEsKQogICAgY29udGV4dC5sb2dfZGF0YXNldCgndGVzdF9zZXQnLCBkZj10ZXN0X3NldCwgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKCiAgICBpZiBtb2RlbF9wa2dfZmlsZToKICAgICAgICBtb2RlbF9jb25maWcgPSBqc29uLmxvYWQob3Blbihtb2RlbF9wa2dfZmlsZSwgInIiKSkKICAgIGVsaWYgbW9kZWxfcGtnX2NsYXNzOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGdldF9tb2RlbF9jb25maWdzKG1vZGVsX3BrZ19jbGFzcykKICAgIGVsc2U6CiAgICAgICAgcmFpc2UgVmFsdWVFcnJvcignbW9kZWxfcGtnX2ZpbGUgb3IgbW9kZWxfcGtnX2NsYXNzIG11c3QgYmUgcHJvdmlkZWQnKQogICAgCiAgICBmb3IgaywgdiBpbiBjb250ZXh0LnBhcmFtZXRlcnMuaXRlbXMoKToKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoJ0NMQVNTXycpOgogICAgICAgICAgICBtb2RlbF9jb25maWdbJ0NMQVNTJ11ba1s2Ol1dID0gdgogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnRklUXycpOgogICAgICAgICAgICBtb2RlbF9jb25maWdbJ0ZJVCddW2tbNDpdXSA9IHYKCiAgICBtb2RlbF9jb25maWdbIkZJVCJdLnVwZGF0ZSh7IlgiOiB4dHJhaW4sInkiOiB5dHJhaW4udmFsdWVzfSkKICAgIAogICAgQ2xhc3NpZmllckNsYXNzID0gY3JlYXRlX2NsYXNzKG1vZGVsX2NvbmZpZ1siTUVUQSJdWyJjbGFzcyJdKQogICAgbW9kZWwgPSBDbGFzc2lmaWVyQ2xhc3MoKiptb2RlbF9jb25maWdbIkNMQVNTIl0pCiAgICBtb2RlbC5maXQoKiptb2RlbF9jb25maWdbIkZJVCJdKQoKICAgIHRyeToKICAgICAgICBkYXRhID0gZHVtcHMobW9kZWwpCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoJ21vZGVsJywgYm9keT1kYXRhLCBsb2NhbF9wYXRoPWYie21vZGVsc19kZXN0fS97bW9kZWxfZmlsZW5hbWV9LnBrbCIpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIlNFUklBTElaRSBNT0RFTCBFUlJPUjoiLCBzdHIoZSkpCgogICAgeXByZWQgPSBtb2RlbC5wcmVkaWN0KHh2YWxpZCkKICAgIHlfc2NvcmUgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKHh2YWxpZCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5X3Njb3JlLnNoYXBlIHt5X3Njb3JlLnNoYXBlfSIpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieXZhbGlkYi5zaGFwZSB7eXZhbGlkYi5zaGFwZX0iKQogICAgaWYgeXZhbGlkYi5zaGFwZVsxXSA+IDE6CiAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl2YWxpZGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dmFsaWRiLCB5X3Njb3JlKSkKICAgIGVsc2U6CiAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl2YWxpZGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmVbOiwgMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dmFsaWRiLCB5X3Njb3JlWzosIDFdKSkKICAgICAgICAKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImF2Z19wcmVjc2NvcmUiLCBhdmVyYWdlX3ByZWNpc2lvbikKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImFjY3VyYWN5IiwgZmxvYXQobW9kZWwuc2NvcmUoeHZhbGlkLCB5dmFsaWQpKSkKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZSh5dmFsaWQsIHlwcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKCiAgICAKICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl2YWxpZGIsIHlfc2NvcmUsIGtleT0icm9jIiwgcGxvdHNfZGlyPXBsb3RzX2Rlc3QpCiAgICBnY2ZfY2xlYXIocGx0KQogICAgbWV0cmljcy5wbG90X2NvbmZ1c2lvbl9tYXRyaXgobW9kZWwsIHh2YWxpZCwgeXZhbGlkLCBsYWJlbHM9bGFiZWxzLnVuaXF1ZSgpLCBub3JtYWxpemU9J3RydWUnKSAKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdCgiY29uZnVzaW9uIiwgYm9keT1wbHQuZ2NmKCkpLCBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L2NvbmZ1c2lvbi5odG1sIikKCg==
    commands: []
    code_origin: https://github.com/mlrun/functions#24da8c6b3f729ae9949fb19f4cfb8ab213f40304:sklearn_classifier.ipynb
