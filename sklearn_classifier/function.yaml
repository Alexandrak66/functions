kind: job
metadata:
  name: sklearn-classifier
  tag: latest
  hash: 427bae4b5f63faec3499da767059960326dfcc9c
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f2b912dadd8>
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: model_pkg_file
        type: str
        doc: json model config file
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      outputs: []
      lineno: 28
  description: train any classifier using scikit-learn's API
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTA0LTAyIDIwOjA4CgppbXBvcnQganNvbgppbXBvcnQgb3MKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzLCBsb2FkCgpmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAppbXBvcnQgc2VhYm9ybiBhcyBzbnMKCmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBsYWJlbF9iaW5hcml6ZQpmcm9tIHNrbGVhcm4ubW9kZWxfc2VsZWN0aW9uIGltcG9ydCB0cmFpbl90ZXN0X3NwbGl0CmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwoKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0CmZyb20gbWxydW4ubWx1dGlscyBpbXBvcnQgZ2V0X2NsYXNzX2ZpdCwgY3JlYXRlX2NsYXNzLCBwbG90X3JvYywgcGxvdF9pbXBvcnRhbmNlLCBnY2ZfY2xlYXIKCmltcG9ydCB3YXJuaW5ncwoKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIgPSAiIiwKICAgIGRhdGFzZXQ6IERhdGFJdGVtID0gJycsCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWxzIiwKICAgIHRlc3Rfc2l6ZTogZmxvYXQgPSAwLjA1LAogICAgdHJhaW5fdmFsX3NwbGl0OiBmbG9hdCA9IDAuNzUsCiAgICBybmc6IGludCA9IDEsCiAgICBtb2RlbF9maWxlbmFtZTogc3RyID0gIm1vZGVsIiwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAiIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICIiLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAibWljcm8iLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLAogICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IgopIC0+IE5vbmU6CiAgICAiIiJ0cmFpbiBhIGNsYXNzaWZpZXIuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIG1vZGVsX3BrZ19jbGFzczogICB0aGUgbW9kZWwgdG8gdHJhaW4sIGUuZywgInNrbGVhcm4ubmV1cmFsX25ldHdvcmtzLk1MUENsYXNzaWZpZXIiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3IganNvbiBtb2RlbCBjb25maWcKICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgKCJkYXRhIikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBtb2RlbF9maWxlbmFtZTogICAgbW9kZWwgZmlsZSBmaWxlbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzIHRvIGEgZGlyZWN0b3J5CiAgICA6cGFyYW0gdGVzdF9zaXplOiAgICAgICAgICgwLjA1KSB0ZXN0IHNldCBzaXplCiAgICA6cGFyYW0gdHJhaW5fdmFsX3NwbGl0OiAgICgwLjc1KSBPbmNlIHRoZSB0ZXN0IHNldCBoYXMgYmVlbiByZW1vdmVkIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFpbmluZyBzZXQgZ2V0cyB0aGlzIHByb3BvcnRpb24uCiAgICA6cGFyYW0gcm5nOiAgICAgICAgICAgICAgICgxKSBza2xlYXJuIHJuZyBzZWVkCiAgICA6cGFyYW0gbW9kZWxzX2Rlc3Q6ICAgICAgIG1vZGVscyBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aAogICAgOnBhcmFtIHBsb3RzX2Rlc3Q6ICAgICAgICBwbG90IHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gc2NvcmVfbWV0aG9kOiAgICAgIGZvciBtdWx0aWNsYXNzIGNsYXNzaWZpY2F0aW9uCiAgICA6cGFyYW0gbW9kZWxfcGtnX2ZpbGU6ICAgIGpzb24gbW9kZWwgY29uZmlnIGZpbGUKICAgIDpwYXJhbSBmaWxlX2V4dDogICAgICAgICAgZm9ybWF0IGZvciB0ZXN0X3NldF9rZXkgaG9sZCBvdXQgZGF0YQogICAgIiIiCiAgICBzcmNmaWxlcGF0aCA9IHN0cihkYXRhc2V0KQogICAgCiAgICBtb2RlbHNfZGVzdCA9IG1vZGVsc19kZXN0IG9yICdtb2RlbHMnCiAgICBwbG90c19kZXN0ID0gcGxvdHNfZGVzdCBvciBmJ3Bsb3RzL3tjb250ZXh0Lm5hbWV9JwogICAgCiAgICBpZiAoc2FtcGxlID09IC0xKSBvciAoc2FtcGxlID49IDEpOgogICAgICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCIuY3N2Iik6CiAgICAgICAgICAgIHJhdyA9IHBkLnJlYWRfY3N2KHNyY2ZpbGVwYXRoKS5kcm9wbmEoKQogICAgICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCIucGFycXVldCIpIG9yIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCIucHEiKToKICAgICAgICAgICAgcmF3ID0gcGQucmVhZF9wYXJxdWV0KHNyY2ZpbGVwYXRoKS5kcm9wbmEoKQogICAgICAgIGVsc2U6CiAgICAgICAgICAgIHJhaXNlIEV4Y2VwdGlvbihmImZpbGUgdHlwZSB1bmhhbmRsZWQge3NyY2ZpbGVwYXRofSIpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCiAgICAgICAgcmF3ID0gcmF3Lmlsb2NbOnNhbXBsZSwgOl0KICAgICAgICBsYWJlbHMgPSBsYWJlbHMuaWxvY1s6c2FtcGxlXQogICAgZWxzZToKICAgICAgICByYXcgPSBwcS5yZWFkX3RhYmxlKHNyY2ZpbGVwYXRoKS50b19wYW5kYXMoKS5kcm9wbmEoKS5zYW1wbGUoc2FtcGxlICogLTEpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCgogICAgY29udGV4dC5oZWFkZXIgPSByYXcuY29sdW1ucy52YWx1ZXMKICAgIAogICAgeWIgPSBsYWJlbF9iaW5hcml6ZShsYWJlbHMsIGNsYXNzZXM9bGFiZWxzLnVuaXF1ZSgpKSAjIGlmIGJpbmFyeSAwLzEgbGFiZWxzLCB3aWxsIHJldHVybiBsYWJlbHMgYXMgaXMKICAgIAogICAgeCwgeHRlc3QsIHksIHl0ZXN0ID0gdHJhaW5fdGVzdF9zcGxpdChucC5jb25jYXRlbmF0ZShbcmF3LCB5Yl0sIGF4aXM9MSksIGxhYmVscywgdGVzdF9zaXplPXRlc3Rfc2l6ZSwgcmFuZG9tX3N0YXRlPXJuZykKICAgIHh0cmFpbiwgeHZhbGlkLCB5dHJhaW4sIHl2YWxpZCA9IHRyYWluX3Rlc3Rfc3BsaXQoeCwgeSwgdHJhaW5fc2l6ZT10cmFpbl92YWxfc3BsaXQsIHJhbmRvbV9zdGF0ZT1ybmcpCiAgICB5dHJhaW5iID0geHRyYWluWzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHRyYWluID0geHRyYWluWzosIDoteWIuc2hhcGVbMV1dLmNvcHkoKQogICAgeXZhbGlkYiA9IHh2YWxpZFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh2YWxpZCA9IHh2YWxpZFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkKICAgIHl0ZXN0YiA9IHh0ZXN0WzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHRlc3QgPSB4dGVzdFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgCiAgICB0ZXN0X3NldCA9IHBkLmNvbmNhdCgKICAgICAgICBbcGQuRGF0YUZyYW1lKGRhdGE9eHRlc3QsIGNvbHVtbnM9Y29udGV4dC5oZWFkZXIpLAogICAgICAgICBwZC5EYXRhRnJhbWUoZGF0YT15dGVzdC52YWx1ZXMsIGNvbHVtbnM9W2xhYmVsX2NvbHVtbl0pXSwKICAgICAgICBheGlzPTEsKQogICAgY29udGV4dC5sb2dfZGF0YXNldCgndGVzdF9zZXQnLCBkZj10ZXN0X3NldCwgZm9ybWF0PWZpbGVfZXh0LCBpbmRleD1GYWxzZSkKCiAgICBpZiBtb2RlbF9wa2dfZmlsZToKICAgICAgICBtb2RlbF9jb25maWcgPSBqc29uLmxvYWQob3Blbihtb2RlbF9wa2dfZmlsZSwgInIiKSkKICAgIGVsaWYgbW9kZWxfcGtnX2NsYXNzOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGdldF9jbGFzc19maXQobW9kZWxfcGtnX2NsYXNzKQogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdtb2RlbF9wa2dfZmlsZSBvciBtb2RlbF9wa2dfY2xhc3MgbXVzdCBiZSBwcm92aWRlZCcpCiAgICAKICAgIGZvciBrLCB2IGluIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpOgogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnQ0xBU1NfJyk6CiAgICAgICAgICAgIG1vZGVsX2NvbmZpZ1snQ0xBU1MnXVtrWzY6XV0gPSB2CiAgICAgICAgaWYgay5zdGFydHN3aXRoKCdGSVRfJyk6CiAgICAgICAgICAgIG1vZGVsX2NvbmZpZ1snRklUJ11ba1s0Ol1dID0gdgoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0cmFpbiwieSI6IHl0cmFpbi52YWx1ZXN9KQogICAgCiAgICBDbGFzc2lmaWVyQ2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKICAgIG1vZGVsLmZpdCgqKm1vZGVsX2NvbmZpZ1siRklUIl0pCgogICAgdHJ5OgogICAgICAgIGRhdGEgPSBkdW1wcyhtb2RlbCkKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdCgnbW9kZWwnLCBib2R5PWRhdGEsIGxvY2FsX3BhdGg9ZiJ7bW9kZWxzX2Rlc3R9L3ttb2RlbF9maWxlbmFtZX0ucGtsIikKICAgIGV4Y2VwdCBFeGNlcHRpb24gYXMgZToKICAgICAgICBwcmludCgiU0VSSUFMSVpFIE1PREVMIEVSUk9SOiIsIHN0cihlKSkKCiAgICB5cHJlZCA9IG1vZGVsLnByZWRpY3QoeHZhbGlkKQogICAgeV9zY29yZSA9IG1vZGVsLnByZWRpY3RfcHJvYmEoeHZhbGlkKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInlfc2NvcmUuc2hhcGUge3lfc2NvcmUuc2hhcGV9IikKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5dmFsaWRiLnNoYXBlIHt5dmFsaWRiLnNoYXBlfSIpCiAgICB0cnk6CiAgICAgICAgaWYgeXZhbGlkYi5zaGFwZVsxXSA+IDE6CiAgICAgICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dmFsaWRiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgeV9zY29yZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXZhbGlkYiwgeV9zY29yZSkpCiAgICAgICAgZWxzZToKICAgICAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl2YWxpZGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5X3Njb3JlWzosIDFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXZlcmFnZT1zY29yZV9tZXRob2QpCiAgICAgICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dmFsaWRiLCB5X3Njb3JlWzosIDFdKSkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhdmdfcHJlY3Njb3JlIiwgYXZlcmFnZV9wcmVjaXNpb24pCiAgICBleGNlcHQ6CiAgICAgICAgY29udGV4dC5sb2dnZXIud2FybignQ291bGRudCBjYWxjdWxhdGUgYXZlcmFnZV9wcmVjaXNpb24nKQogICAgICAgIAogICAgdHJ5OgogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImFjY3VyYWN5IiwgZmxvYXQobW9kZWwuc2NvcmUoeHZhbGlkLCB5dmFsaWQpKSkKICAgIGV4Y2VwdDoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdDb3VsZG50IGNhbGN1bGF0ZSBhY2N1cmFjeScpCiAgICB0cnk6CiAgICAgICAgY29udGV4dC5sb2dfcmVzdWx0KGYiZjFfc2NvcmUiLCBtZXRyaWNzLmYxX3Njb3JlKHl2YWxpZCwgeXByZWQsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKICAgIGV4Y2VwdDoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdDb3VsZG50IGNhbGN1bGF0ZSBmMV9zY29yZScpCgogICAgdHJ5OgogICAgICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl2YWxpZGIsIHlfc2NvcmUsIGtleT0icm9jIiwgcGxvdHNfZGlyPXBsb3RzX2Rlc3QpCiAgICAgICAgZ2NmX2NsZWFyKHBsdCkKICAgIGV4Y2VwdDoKICAgICAgICBjb250ZXh0LmxvZ2dlci5pbmZvKCdDb3VsZG50IGNyZWF0ZSByb2MgY3VydmUnKQogICAgdHJ5OgogICAgICAgIG1ldHJpY3MucGxvdF9jb25mdXNpb25fbWF0cml4KG1vZGVsLCB4dmFsaWQsIHl2YWxpZCwgbGFiZWxzPWxhYmVscy51bmlxdWUoKSwgbm9ybWFsaXplPSd0cnVlJykgCiAgICAgICAgY29udGV4dC5sb2dfYXJ0aWZhY3QoUGxvdEFydGlmYWN0KCJjb25mdXNpb24iLCBib2R5PXBsdC5nY2YoKSksIGxvY2FsX3BhdGg9ZiJ7cGxvdHNfZGVzdH0vY29uZnVzaW9uLmh0bWwiKQogICAgZXhjZXB0OgogICAgICAgIGNvbnRleHQubG9nZ2VyLmluZm8oJ0NvdWxkbnQgcGxvdCBjb25mdXNpb24gbWF0cml4JykKCg==
    commands: []
    code_origin: https://github.com/mlrun/functions.git#a7b6f417f33ef1ab5c9367f992c81fb1c9dea2f4:sklearn_classifier.ipynb
