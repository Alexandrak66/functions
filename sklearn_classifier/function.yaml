kind: job
metadata:
  name: sklearn-classifier
  tag: latest
  hash: 7f2c22499c371e7b4c73bd731677a49d3ae069ab
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: dataset
        type: DataItem
        doc: ("data") name of raw data file
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7f0e8e108cf8>
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: model_filename
        type: str
        doc: model file filename, points to a directory
        default: model
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: model_pkg_file
        type: str
        doc: json model config file
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      outputs: []
      lineno: 30
  description: train any classifier using scikit-learn's API
  image_pull_policy: Always
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI5IDIwOjAxCgppbXBvcnQganNvbgppbXBvcnQgb3MKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXBzLCBsb2FkCgpmcm9tIHNrbGVhcm4gaW1wb3J0IG1ldHJpY3MKaW1wb3J0IHBhbmRhcyBhcyBwZAppbXBvcnQgbnVtcHkgYXMgbnAKaW1wb3J0IG1hdHBsb3RsaWIucHlwbG90IGFzIHBsdAppbXBvcnQgc2VhYm9ybiBhcyBzbnMKCmZyb20gc2tsZWFybi5wcmVwcm9jZXNzaW5nIGltcG9ydCBsYWJlbF9iaW5hcml6ZQpmcm9tIHNrbGVhcm4ubW9kZWxfc2VsZWN0aW9uIGltcG9ydCB0cmFpbl90ZXN0X3NwbGl0CmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwoKZnJvbSB0eXBpbmcgaW1wb3J0IExpc3QKZnJvbSBtbHJ1bi5leGVjdXRpb24gaW1wb3J0IE1MQ2xpZW50Q3R4CmZyb20gbWxydW4uZGF0YXN0b3JlIGltcG9ydCBEYXRhSXRlbQpmcm9tIG1scnVuLmFydGlmYWN0cyBpbXBvcnQgUGxvdEFydGlmYWN0Cgpmcm9tIG1sdXRpbHMubW9kZWxzIGltcG9ydCBnZXRfbW9kZWxfY29uZmlncywgY3JlYXRlX2NsYXNzCmZyb20gbWx1dGlscy5wbG90cyBpbXBvcnQgcGxvdF9yb2MsIHBsb3RfaW1wb3J0YW5jZSwgZ2NmX2NsZWFyCgppbXBvcnQgd2FybmluZ3MKCndhcm5pbmdzLnNpbXBsZWZpbHRlcihhY3Rpb249Imlnbm9yZSIsIGNhdGVnb3J5PUZ1dHVyZVdhcm5pbmcpCgpkZWYgdHJhaW5fbW9kZWwoCiAgICBjb250ZXh0OiBNTENsaWVudEN0eCwKICAgIG1vZGVsX3BrZ19jbGFzczogc3RyID0gIiIsCiAgICBkYXRhc2V0OiBEYXRhSXRlbSA9IE5vbmUsCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWxzIiwKICAgIHRlc3Rfc2l6ZTogZmxvYXQgPSAwLjA1LAogICAgdHJhaW5fdmFsX3NwbGl0OiBmbG9hdCA9IDAuNzUsCiAgICBybmc6IGludCA9IDEsCiAgICBtb2RlbF9maWxlbmFtZTogc3RyID0gIm1vZGVsIiwKICAgIG1vZGVsc19kZXN0OiBzdHIgPSAiIiwKICAgIHBsb3RzX2Rlc3Q6IHN0ciA9ICIiLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAibWljcm8iLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLAogICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IgopIC0+IE5vbmU6CiAgICAiIiJ0cmFpbiBhIGNsYXNzaWZpZXIuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIG1vZGVsX3BrZ19jbGFzczogICB0aGUgbW9kZWwgdG8gdHJhaW4sIGUuZywgInNrbGVhcm4ubmV1cmFsX25ldHdvcmtzLk1MUENsYXNzaWZpZXIiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3IganNvbiBtb2RlbCBjb25maWcKICAgIDpwYXJhbSBkYXRhc2V0OiAgICAgICAgICAgKCJkYXRhIikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBtb2RlbF9maWxlbmFtZTogICAgbW9kZWwgZmlsZSBmaWxlbmFtZSwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgcG9pbnRzIHRvIGEgZGlyZWN0b3J5CiAgICA6cGFyYW0gdGVzdF9zaXplOiAgICAgICAgICgwLjA1KSB0ZXN0IHNldCBzaXplCiAgICA6cGFyYW0gdHJhaW5fdmFsX3NwbGl0OiAgICgwLjc1KSBPbmNlIHRoZSB0ZXN0IHNldCBoYXMgYmVlbiByZW1vdmVkIHRoZQogICAgICAgICAgICAgICAgICAgICAgICAgICAgICB0cmFpbmluZyBzZXQgZ2V0cyB0aGlzIHByb3BvcnRpb24uCiAgICA6cGFyYW0gcm5nOiAgICAgICAgICAgICAgICgxKSBza2xlYXJuIHJuZyBzZWVkCiAgICA6cGFyYW0gbW9kZWxzX2Rlc3Q6ICAgICAgIG1vZGVscyBzdWJmb2xkZXIgb24gYXJ0aWZhY3QgcGF0aAogICAgOnBhcmFtIHBsb3RzX2Rlc3Q6ICAgICAgICBwbG90IHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gc2NvcmVfbWV0aG9kOiAgICAgIGZvciBtdWx0aWNsYXNzIGNsYXNzaWZpY2F0aW9uCiAgICA6cGFyYW0gbW9kZWxfcGtnX2ZpbGU6ICAgIGpzb24gbW9kZWwgY29uZmlnIGZpbGUKICAgIDpwYXJhbSBmaWxlX2V4dDogICAgICAgICAgZm9ybWF0IGZvciB0ZXN0X3NldF9rZXkgaG9sZCBvdXQgZGF0YQogICAgIiIiCiAgICBzcmNmaWxlcGF0aCA9IHN0cihkYXRhc2V0KQogICAgCiAgICBtb2RlbHNfZGVzdCA9IG1vZGVsc19kZXN0IG9yICdtb2RlbHMnCiAgICBwbG90c19kZXN0ID0gcGxvdHNfZGVzdCBvciBmJ3Bsb3RzL3tjb250ZXh0Lm5hbWV9JwogICAgCiAgICBpZiAoc2FtcGxlID09IC0xKSBvciAoc2FtcGxlID49IDEpOgogICAgICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCIuY3N2Iik6CiAgICAgICAgICAgIHJhdyA9IHBkLnJlYWRfY3N2KHNyY2ZpbGVwYXRoKS5kcm9wbmEoKQogICAgICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCJwYXJxdWV0Iikgb3Igc3JjZmlsZXBhdGguZW5kc3dpdGgoInBxIik6CiAgICAgICAgICAgIHJhdyA9IHBkLnJlYWRfcGFycXVldChzcmNmaWxlcGF0aCkuZHJvcG5hKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oImZpbGUgdHlwZSB1bmhhbmRsZWQiKQogICAgICAgIGxhYmVscyA9IHJhdy5wb3AobGFiZWxfY29sdW1uKQogICAgICAgIHJhdyA9IHJhdy5pbG9jWzpzYW1wbGUsIDpdCiAgICAgICAgbGFiZWxzID0gbGFiZWxzLmlsb2NbOnNhbXBsZV0KICAgIGVsc2U6CiAgICAgICAgcmF3ID0gcHEucmVhZF90YWJsZShzcmNmaWxlcGF0aCkudG9fcGFuZGFzKCkuZHJvcG5hKCkuc2FtcGxlKHNhbXBsZSAqIC0xKQogICAgICAgIGxhYmVscyA9IHJhdy5wb3AobGFiZWxfY29sdW1uKQoKICAgIGNvbnRleHQuaGVhZGVyID0gcmF3LmNvbHVtbnMudmFsdWVzCiAgICAKICAgIHliID0gbGFiZWxfYmluYXJpemUobGFiZWxzLCBjbGFzc2VzPWxhYmVscy51bmlxdWUoKSkgIyBpZiBiaW5hcnkgMC8xIGxhYmVscywgd2lsbCByZXR1cm4gbGFiZWxzIGFzIGlzCiAgICAKICAgIHgsIHh0ZXN0LCB5LCB5dGVzdCA9IHRyYWluX3Rlc3Rfc3BsaXQobnAuY29uY2F0ZW5hdGUoW3JhdywgeWJdLCBheGlzPTEpLCBsYWJlbHMsIHRlc3Rfc2l6ZT10ZXN0X3NpemUsIHJhbmRvbV9zdGF0ZT1ybmcpCiAgICB4dHJhaW4sIHh2YWxpZCwgeXRyYWluLCB5dmFsaWQgPSB0cmFpbl90ZXN0X3NwbGl0KHgsIHksIHRyYWluX3NpemU9dHJhaW5fdmFsX3NwbGl0LCByYW5kb21fc3RhdGU9cm5nKQogICAgeXRyYWluYiA9IHh0cmFpbls6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh0cmFpbiA9IHh0cmFpbls6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkKICAgIHl2YWxpZGIgPSB4dmFsaWRbOiwgLXliLnNoYXBlWzFdOl0uY29weSgpCiAgICB4dmFsaWQgPSB4dmFsaWRbOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpCiAgICB5dGVzdGIgPSB4dGVzdFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh0ZXN0ID0geHRlc3RbOiwgOi15Yi5zaGFwZVsxXV0uY29weSgpICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAKICAgIAogICAgdGVzdF9zZXQgPSBwZC5jb25jYXQoCiAgICAgICAgW3BkLkRhdGFGcmFtZShkYXRhPXh0ZXN0LCBjb2x1bW5zPWNvbnRleHQuaGVhZGVyKSwKICAgICAgICAgcGQuRGF0YUZyYW1lKGRhdGE9eXRlc3QudmFsdWVzLCBjb2x1bW5zPVtsYWJlbF9jb2x1bW5dKV0sCiAgICAgICAgYXhpcz0xLCkKICAgIGNvbnRleHQubG9nX2RhdGFzZXQoJ3Rlc3Rfc2V0JywgZGY9dGVzdF9zZXQsIGZvcm1hdD1maWxlX2V4dCwgaW5kZXg9RmFsc2UpCgogICAgaWYgbW9kZWxfcGtnX2ZpbGU6CiAgICAgICAgbW9kZWxfY29uZmlnID0ganNvbi5sb2FkKG9wZW4obW9kZWxfcGtnX2ZpbGUsICJyIikpCiAgICBlbGlmIG1vZGVsX3BrZ19jbGFzczoKICAgICAgICBtb2RlbF9jb25maWcgPSBnZXRfbW9kZWxfY29uZmlncyhtb2RlbF9wa2dfY2xhc3MpCiAgICBlbHNlOgogICAgICAgIHJhaXNlIFZhbHVlRXJyb3IoJ21vZGVsX3BrZ19maWxlIG9yIG1vZGVsX3BrZ19jbGFzcyBtdXN0IGJlIHByb3ZpZGVkJykKICAgIAogICAgZm9yIGssIHYgaW4gY29udGV4dC5wYXJhbWV0ZXJzLml0ZW1zKCk6CiAgICAgICAgaWYgay5zdGFydHN3aXRoKCdDTEFTU18nKToKICAgICAgICAgICAgbW9kZWxfY29uZmlnWydDTEFTUyddW2tbNjpdXSA9IHYKICAgICAgICBpZiBrLnN0YXJ0c3dpdGgoJ0ZJVF8nKToKICAgICAgICAgICAgbW9kZWxfY29uZmlnWydGSVQnXVtrWzQ6XV0gPSB2CgogICAgbW9kZWxfY29uZmlnWyJGSVQiXS51cGRhdGUoeyJYIjogeHRyYWluLCJ5IjogeXRyYWluLnZhbHVlc30pCiAgICAKICAgIENsYXNzaWZpZXJDbGFzcyA9IGNyZWF0ZV9jbGFzcyhtb2RlbF9jb25maWdbIk1FVEEiXVsiY2xhc3MiXSkKICAgIG1vZGVsID0gQ2xhc3NpZmllckNsYXNzKCoqbW9kZWxfY29uZmlnWyJDTEFTUyJdKQogICAgbW9kZWwuZml0KCoqbW9kZWxfY29uZmlnWyJGSVQiXSkKCiAgICB0cnk6CiAgICAgICAgZGF0YSA9IGR1bXBzKG1vZGVsKQogICAgICAgIGNvbnRleHQubG9nX2FydGlmYWN0KCdtb2RlbCcsIGJvZHk9ZGF0YSwgbG9jYWxfcGF0aD1mInttb2RlbHNfZGVzdH0ve21vZGVsX2ZpbGVuYW1lfS5wa2wiKQogICAgZXhjZXB0IEV4Y2VwdGlvbiBhcyBlOgogICAgICAgIHByaW50KCJTRVJJQUxJWkUgTU9ERUwgRVJST1I6Iiwgc3RyKGUpKQoKICAgIHlwcmVkID0gbW9kZWwucHJlZGljdCh4dmFsaWQpCiAgICB5X3Njb3JlID0gbW9kZWwucHJlZGljdF9wcm9iYSh4dmFsaWQpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieV9zY29yZS5zaGFwZSB7eV9zY29yZS5zaGFwZX0iKQogICAgY29udGV4dC5sb2dnZXIuaW5mbyhmInl2YWxpZGIuc2hhcGUge3l2YWxpZGIuc2hhcGV9IikKICAgIGlmIHl2YWxpZGIuc2hhcGVbMV0gPiAxOgogICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dmFsaWRiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5X3Njb3JlLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXZhbGlkYiwgeV9zY29yZSkpCiAgICBlbHNlOgogICAgICAgIGF2ZXJhZ2VfcHJlY2lzaW9uID0gbWV0cmljcy5hdmVyYWdlX3ByZWNpc2lvbl9zY29yZSh5dmFsaWRiLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICB5X3Njb3JlWzosIDFdLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkKICAgICAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJyb2NhdWMiLCBtZXRyaWNzLnJvY19hdWNfc2NvcmUoeXZhbGlkYiwgeV9zY29yZVs6LCAxXSkpCiAgICAgICAgCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhdmdfcHJlY3Njb3JlIiwgYXZlcmFnZV9wcmVjaXNpb24pCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJhY2N1cmFjeSIsIGZsb2F0KG1vZGVsLnNjb3JlKHh2YWxpZCwgeXZhbGlkKSkpCiAgICBjb250ZXh0LmxvZ19yZXN1bHQoZiJmMV9zY29yZSIsIG1ldHJpY3MuZjFfc2NvcmUoeXZhbGlkLCB5cHJlZCwKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhdmVyYWdlPXNjb3JlX21ldGhvZCkpCgogICAgCiAgICBwbG90X3JvYyhjb250ZXh0LCB5dmFsaWRiLCB5X3Njb3JlLCBrZXk9InJvYyIsIHBsb3RzX2Rpcj1wbG90c19kZXN0KQogICAgZ2NmX2NsZWFyKHBsdCkKICAgIG1ldHJpY3MucGxvdF9jb25mdXNpb25fbWF0cml4KG1vZGVsLCB4dmFsaWQsIHl2YWxpZCwgbGFiZWxzPWxhYmVscy51bmlxdWUoKSwgbm9ybWFsaXplPSd0cnVlJykgCiAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChQbG90QXJ0aWZhY3QoImNvbmZ1c2lvbiIsIGJvZHk9cGx0LmdjZigpKSwgbG9jYWxfcGF0aD1mIntwbG90c19kZXN0fS9jb25mdXNpb24uaHRtbCIpCgo=
    commands: []
    code_origin: https://github.com/mlrun/functions.git#c866d13dae8dc135b262f6aacd785f2f5d74e189:sklearn_classifier.ipynb
