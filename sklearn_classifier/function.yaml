kind: job
metadata:
  name: sklearn-classifier
  tag: latest
  hash: 94c1d43f8ab5085066d7081ae538c2bd5ea4effd
  project: ''
  labels:
    author: yjb
  categories:
  - models
  - classifier
spec:
  command: ''
  args: []
  image: mlrun/ml-models-gpu:0.4.6
  env: []
  default_handler: train_model
  entry_points:
    train_model:
      name: train_model
      doc: train a classifier.
      parameters:
      - name: context
        type: MLClientCtx
        doc: the function context
      - name: model_pkg_class
        type: str
        doc: the model to train, e.g, "sklearn.neural_networks.MLPClassifier",  or
          json model config
      - name: data_key
        type: str
        doc: ("data") name of raw data file
        default: data
      - name: sample
        type: int
        doc: Selects the first n rows, or select a sample starting from the first.
          If negative <-1, select a random sample
        default: <_ast.USub object at 0x7fb4ee001cd0>
      - name: label_column
        type: str
        doc: ground-truth (y) labels
        default: labels
      - name: model_key
        type: str
        doc: ("model") name of model in artifact store, points to a directory
        default: model
      - name: test_size
        type: float
        doc: (0.05) test set size
        default: 0.05
      - name: train_val_split
        type: float
        doc: (0.75) Once the test set has been removed the training set gets this
          proportion.
        default: 0.75
      - name: test_set_key
        type: str
        doc: store the test data set under this key in the artifact store
        default: test_set
      - name: rng
        type: int
        doc: (1) sklearn rng seed
        default: 1
      - name: models_dest
        type: str
        doc: models subfolder on artifact path
        default: models
      - name: plots_dest
        type: str
        doc: plot subfolder on artifact path
        default: plots
      - name: score_method
        type: str
        doc: for multiclass classification
        default: micro
      - name: model_pkg_file
        type: str
        doc: json model config file
      - name: file_ext
        type: str
        doc: format for test_set_key hold out data
        default: parquet
      outputs: []
      lineno: 30
  description: train any classifier using scikit-learn's API
  image_pull_policy: Always
  build:
    functionSourceCode: IyBHZW5lcmF0ZWQgYnkgbnVjbGlvLmV4cG9ydC5OdWNsaW9FeHBvcnRlciBvbiAyMDIwLTAzLTI4IDA1OjIzCgppbXBvcnQganNvbgppbXBvcnQgb3MKCmZyb20gY2xvdWRwaWNrbGUgaW1wb3J0IGR1bXAsIGxvYWQKCmZyb20gc2tsZWFybiBpbXBvcnQgbWV0cmljcwppbXBvcnQgcGFuZGFzIGFzIHBkCmltcG9ydCBudW1weSBhcyBucAppbXBvcnQgbWF0cGxvdGxpYi5weXBsb3QgYXMgcGx0CmltcG9ydCBzZWFib3JuIGFzIHNucwoKZnJvbSBza2xlYXJuLnByZXByb2Nlc3NpbmcgaW1wb3J0IGxhYmVsX2JpbmFyaXplCmZyb20gc2tsZWFybi5tb2RlbF9zZWxlY3Rpb24gaW1wb3J0IHRyYWluX3Rlc3Rfc3BsaXQKZnJvbSBza2xlYXJuIGltcG9ydCBtZXRyaWNzCgpmcm9tIHR5cGluZyBpbXBvcnQgTGlzdApmcm9tIG1scnVuLmV4ZWN1dGlvbiBpbXBvcnQgTUxDbGllbnRDdHgKZnJvbSBtbHJ1bi5kYXRhc3RvcmUgaW1wb3J0IERhdGFJdGVtCmZyb20gbWxydW4uYXJ0aWZhY3RzIGltcG9ydCBQbG90QXJ0aWZhY3QKCmZyb20gbWx1dGlscy5tb2RlbHMgaW1wb3J0IGdldF9tb2RlbF9jb25maWdzLCBjcmVhdGVfY2xhc3MKZnJvbSBtbHV0aWxzLnBsb3RzIGltcG9ydCBwbG90X3JvYywgcGxvdF9pbXBvcnRhbmNlLCBnY2ZfY2xlYXIKCmltcG9ydCB3YXJuaW5ncwoKd2FybmluZ3Muc2ltcGxlZmlsdGVyKGFjdGlvbj0iaWdub3JlIiwgY2F0ZWdvcnk9RnV0dXJlV2FybmluZykKCmRlZiB0cmFpbl9tb2RlbCgKICAgIGNvbnRleHQ6IE1MQ2xpZW50Q3R4LAogICAgbW9kZWxfcGtnX2NsYXNzOiBzdHIgPSAiIiwKICAgIGRhdGFfa2V5OiBzdHIgPSAiZGF0YSIsCiAgICBzYW1wbGU6IGludCA9IC0xLAogICAgbGFiZWxfY29sdW1uOiBzdHIgPSAibGFiZWxzIiwKICAgIG1vZGVsX2tleTogc3RyID0gIm1vZGVsIiwKICAgIHRlc3Rfc2l6ZTogZmxvYXQgPSAwLjA1LAogICAgdHJhaW5fdmFsX3NwbGl0OiBmbG9hdCA9IDAuNzUsCiAgICB0ZXN0X3NldF9rZXk6IHN0ciA9ICJ0ZXN0X3NldCIsCiAgICBybmc6IGludCA9IDEsCiAgICBtb2RlbHNfZGVzdDogc3RyID0gIm1vZGVscyIsCiAgICBwbG90c19kZXN0OiBzdHIgPSAicGxvdHMiLAogICAgc2NvcmVfbWV0aG9kOiBzdHIgPSAibWljcm8iLAogICAgbW9kZWxfcGtnX2ZpbGU6IHN0ciA9ICIiLAogICAgZmlsZV9leHQ6IHN0ciA9ICJwYXJxdWV0IgopIC0+IE5vbmU6CiAgICAiIiJ0cmFpbiBhIGNsYXNzaWZpZXIuCgogICAgOnBhcmFtIGNvbnRleHQ6ICAgICAgICAgICB0aGUgZnVuY3Rpb24gY29udGV4dAogICAgOnBhcmFtIG1vZGVsX3BrZ19jbGFzczogICB0aGUgbW9kZWwgdG8gdHJhaW4sIGUuZywgInNrbGVhcm4ubmV1cmFsX25ldHdvcmtzLk1MUENsYXNzaWZpZXIiLCAKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgb3IganNvbiBtb2RlbCBjb25maWcKICAgIDpwYXJhbSBkYXRhX2tleTogICAgICAgICAgKCJkYXRhIikgbmFtZSBvZiByYXcgZGF0YSBmaWxlCiAgICA6cGFyYW0gc2FtcGxlOiAgICAgICAgICAgIFNlbGVjdHMgdGhlIGZpcnN0IG4gcm93cywgb3Igc2VsZWN0IGEgc2FtcGxlCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHN0YXJ0aW5nIGZyb20gdGhlIGZpcnN0LiBJZiBuZWdhdGl2ZSA8LTEsIHNlbGVjdAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICBhIHJhbmRvbSBzYW1wbGUKICAgIDpwYXJhbSBsYWJlbF9jb2x1bW46ICAgICAgZ3JvdW5kLXRydXRoICh5KSBsYWJlbHMKICAgIDpwYXJhbSBtb2RlbF9rZXk6ICAgICAgICAgKCJtb2RlbCIpIG5hbWUgb2YgbW9kZWwgaW4gYXJ0aWZhY3Qgc3RvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHBvaW50cyB0byBhIGRpcmVjdG9yeQogICAgOnBhcmFtIHRlc3Rfc2l6ZTogICAgICAgICAoMC4wNSkgdGVzdCBzZXQgc2l6ZQogICAgOnBhcmFtIHRyYWluX3ZhbF9zcGxpdDogICAoMC43NSkgT25jZSB0aGUgdGVzdCBzZXQgaGFzIGJlZW4gcmVtb3ZlZCB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgdHJhaW5pbmcgc2V0IGdldHMgdGhpcyBwcm9wb3J0aW9uLgogICAgOnBhcmFtIHRlc3Rfc2V0X2tleTogICAgICBzdG9yZSB0aGUgdGVzdCBkYXRhIHNldCB1bmRlciB0aGlzIGtleSBpbiB0aGUKICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgYXJ0aWZhY3Qgc3RvcmUKICAgIDpwYXJhbSBybmc6ICAgICAgICAgICAgICAgKDEpIHNrbGVhcm4gcm5nIHNlZWQKICAgIDpwYXJhbSBtb2RlbHNfZGVzdDogICAgICAgbW9kZWxzIHN1YmZvbGRlciBvbiBhcnRpZmFjdCBwYXRoCiAgICA6cGFyYW0gcGxvdHNfZGVzdDogICAgICAgIHBsb3Qgc3ViZm9sZGVyIG9uIGFydGlmYWN0IHBhdGgKICAgIDpwYXJhbSBzY29yZV9tZXRob2Q6ICAgICAgZm9yIG11bHRpY2xhc3MgY2xhc3NpZmljYXRpb24KICAgIDpwYXJhbSBtb2RlbF9wa2dfZmlsZTogICAganNvbiBtb2RlbCBjb25maWcgZmlsZQogICAgOnBhcmFtIGZpbGVfZXh0OiAgICAgICAgICBmb3JtYXQgZm9yIHRlc3Rfc2V0X2tleSBob2xkIG91dCBkYXRhCiAgICAiIiIKICAgIHNyY2ZpbGVwYXRoID0gc3RyKGRhdGFfa2V5KQogICAgCiAgICBpZiAoc2FtcGxlID09IC0xKSBvciAoc2FtcGxlID49IDEpOgogICAgICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCIuY3N2Iik6CiAgICAgICAgICAgIHJhdyA9IHBkLnJlYWRfY3N2KHNyY2ZpbGVwYXRoKS5kcm9wbmEoKQogICAgICAgIGlmIHNyY2ZpbGVwYXRoLmVuZHN3aXRoKCJwYXJxdWV0Iikgb3Igc3JjZmlsZXBhdGguZW5kc3dpdGgoInBxIik6CiAgICAgICAgICAgIHJhdyA9IHBkLnJlYWRfcGFycXVldChzcmNmaWxlcGF0aCkuZHJvcG5hKCkKICAgICAgICBlbHNlOgogICAgICAgICAgICByYWlzZSBFeGNlcHRpb24oImZpbGUgdHlwZSB1bmhhbmRsZWQiKQogICAgICAgIGxhYmVscyA9IHJhdy5wb3AobGFiZWxfY29sdW1uKQogICAgICAgIHJhdyA9IHJhdy5pbG9jWzpzYW1wbGUsIDpdCiAgICAgICAgbGFiZWxzID0gbGFiZWxzLmlsb2NbOnNhbXBsZV0KICAgIGVsc2U6CiAgICAgICAgcmF3ID0gcGQucmVhZF9wYXJxdWV0KHNyY2ZpbGVwYXRoKS5kcm9wbmEoKS5zYW1wbGUoc2FtcGxlICogLTEpCiAgICAgICAgbGFiZWxzID0gcmF3LnBvcChsYWJlbF9jb2x1bW4pCgogICAgY29udGV4dC5oZWFkZXIgPSByYXcuY29sdW1ucy52YWx1ZXMKICAgIAogICAgeWIgPSBsYWJlbF9iaW5hcml6ZShsYWJlbHMsIGNsYXNzZXM9bGFiZWxzLnVuaXF1ZSgpKSAjIGlmIGJpbmFyeSAwLzEgbGFiZWxzLCB3aWxsIHJldHVybiBsYWJlbHMgYXMgaXMKICAgIAogICAgeCwgeHRlc3QsIHksIHl0ZXN0ID0gdHJhaW5fdGVzdF9zcGxpdChucC5jb25jYXRlbmF0ZShbcmF3LCB5Yl0sIGF4aXM9MSksIGxhYmVscywgdGVzdF9zaXplPXRlc3Rfc2l6ZSwgcmFuZG9tX3N0YXRlPXJuZykKICAgIHh0cmFpbiwgeHZhbGlkLCB5dHJhaW4sIHl2YWxpZCA9IHRyYWluX3Rlc3Rfc3BsaXQoeCwgeSwgdHJhaW5fc2l6ZT10cmFpbl92YWxfc3BsaXQsIHJhbmRvbV9zdGF0ZT1ybmcpCiAgICB5dHJhaW5iID0geHRyYWluWzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHRyYWluID0geHRyYWluWzosIDoteWIuc2hhcGVbMV1dLmNvcHkoKQogICAgeXZhbGlkYiA9IHh2YWxpZFs6LCAteWIuc2hhcGVbMV06XS5jb3B5KCkKICAgIHh2YWxpZCA9IHh2YWxpZFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkKICAgIHl0ZXN0YiA9IHh0ZXN0WzosIC15Yi5zaGFwZVsxXTpdLmNvcHkoKQogICAgeHRlc3QgPSB4dGVzdFs6LCA6LXliLnNoYXBlWzFdXS5jb3B5KCkgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIAogICAgCiAgICB0ZXN0X3NldCA9IHBkLmNvbmNhdCgKICAgICAgICBbcGQuRGF0YUZyYW1lKGRhdGE9eHRlc3QsIGNvbHVtbnM9Y29udGV4dC5oZWFkZXIpLAogICAgICAgICBwZC5EYXRhRnJhbWUoZGF0YT15dGVzdC52YWx1ZXMsIGNvbHVtbnM9W2xhYmVsX2NvbHVtbl0pXSwKICAgICAgICBheGlzPTEsKQogICAgY29udGV4dC5sb2dfZGF0YXNldCh0ZXN0X3NldF9rZXksIGRmPXRlc3Rfc2V0LCBmb3JtYXQ9ZmlsZV9leHQsIGluZGV4PUZhbHNlKQoKICAgIGlmIG1vZGVsX3BrZ19maWxlOgogICAgICAgIG1vZGVsX2NvbmZpZyA9IGpzb24ubG9hZChvcGVuKG1vZGVsX3BrZ19maWxlLCAiciIpKQogICAgZWxpZiBtb2RlbF9wa2dfY2xhc3M6CiAgICAgICAgbW9kZWxfY29uZmlnID0gZ2V0X21vZGVsX2NvbmZpZ3MobW9kZWxfcGtnX2NsYXNzKQogICAgZWxzZToKICAgICAgICByYWlzZSBWYWx1ZUVycm9yKCdtb2RlbF9wa2dfZmlsZSBvciBtb2RlbF9wa2dfY2xhc3MgbXVzdCBiZSBwcm92aWRlZCcpCiAgICAKICAgIGZvciBrLCB2IGluIGNvbnRleHQucGFyYW1ldGVycy5pdGVtcygpOgogICAgICAgIGlmIGsuc3RhcnRzd2l0aCgnQ0xBU1NfJyk6CiAgICAgICAgICAgIG1vZGVsX2NvbmZpZ1snQ0xBU1MnXVtrWzY6XV0gPSB2CiAgICAgICAgaWYgay5zdGFydHN3aXRoKCdGSVRfJyk6CiAgICAgICAgICAgIG1vZGVsX2NvbmZpZ1snRklUJ11ba1s0Ol1dID0gdgoKICAgIG1vZGVsX2NvbmZpZ1siRklUIl0udXBkYXRlKHsiWCI6IHh0cmFpbiwieSI6IHl0cmFpbi52YWx1ZXN9KQogICAgCiAgICBDbGFzc2lmaWVyQ2xhc3MgPSBjcmVhdGVfY2xhc3MobW9kZWxfY29uZmlnWyJNRVRBIl1bImNsYXNzIl0pCiAgICBtb2RlbCA9IENsYXNzaWZpZXJDbGFzcygqKm1vZGVsX2NvbmZpZ1siQ0xBU1MiXSkKICAgIG1vZGVsLmZpdCgqKm1vZGVsX2NvbmZpZ1siRklUIl0pCgogICAgZmlsZXBhdGggPSBvcy5wYXRoLmpvaW4oY29udGV4dC5hcnRpZmFjdF9wYXRoLCBmInttb2RlbHNfZGVzdH0ve21vZGVsX2tleX0ucGtsIikKICAgIG9zLm1ha2VkaXJzKG9zLnBhdGguam9pbihjb250ZXh0LmFydGlmYWN0X3BhdGgsIG1vZGVsc19kZXN0KSwgZXhpc3Rfb2s9VHJ1ZSkKICAgIHRyeToKICAgICAgICBkdW1wKG1vZGVsLCBvcGVuKGZpbGVwYXRoLCAid2IiKSkKICAgICAgICBjb250ZXh0LmxvZ19hcnRpZmFjdChtb2RlbF9rZXksIGxvY2FsX3BhdGg9bW9kZWxzX2Rlc3QpCiAgICBleGNlcHQgRXhjZXB0aW9uIGFzIGU6CiAgICAgICAgcHJpbnQoIlNFUklBTElaRSBNT0RFTCBFUlJPUjoiLCBzdHIoZSkpCgogICAgeXByZWQgPSBtb2RlbC5wcmVkaWN0KHh2YWxpZCkKICAgIHlfc2NvcmUgPSBtb2RlbC5wcmVkaWN0X3Byb2JhKHh2YWxpZCkKICAgIGNvbnRleHQubG9nZ2VyLmluZm8oZiJ5X3Njb3JlLnNoYXBlIHt5X3Njb3JlLnNoYXBlfSIpCiAgICBjb250ZXh0LmxvZ2dlci5pbmZvKGYieXZhbGlkYi5zaGFwZSB7eXZhbGlkYi5zaGFwZX0iKQogICAgaWYgeXZhbGlkYi5zaGFwZVsxXSA+IDE6CiAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl2YWxpZGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmUsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dmFsaWRiLCB5X3Njb3JlKSkKICAgIGVsc2U6CiAgICAgICAgYXZlcmFnZV9wcmVjaXNpb24gPSBtZXRyaWNzLmF2ZXJhZ2VfcHJlY2lzaW9uX3Njb3JlKHl2YWxpZGIsCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIHlfc2NvcmVbOiwgMV0sCiAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKQogICAgICAgIGNvbnRleHQubG9nX3Jlc3VsdChmInJvY2F1YyIsIG1ldHJpY3Mucm9jX2F1Y19zY29yZSh5dmFsaWRiLCB5X3Njb3JlWzosIDFdKSkKICAgICAgICAKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImF2Z19wcmVjc2NvcmUiLCBhdmVyYWdlX3ByZWNpc2lvbikKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImFjY3VyYWN5IiwgZmxvYXQobW9kZWwuc2NvcmUoeHZhbGlkLCB5dmFsaWQpKSkKICAgIGNvbnRleHQubG9nX3Jlc3VsdChmImYxX3Njb3JlIiwgbWV0cmljcy5mMV9zY29yZSh5dmFsaWQsIHlwcmVkLAogICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIGF2ZXJhZ2U9c2NvcmVfbWV0aG9kKSkKCiAgICAKICAgIHBsb3Rfcm9jKGNvbnRleHQsIHl2YWxpZGIsIHlfc2NvcmUpCiAgICBnY2ZfY2xlYXIocGx0KQogICAgbWV0cmljcy5wbG90X2NvbmZ1c2lvbl9tYXRyaXgobW9kZWwsIHh2YWxpZCwgeXZhbGlkLCBsYWJlbHM9bGFiZWxzLnVuaXF1ZSgpLCBub3JtYWxpemU9J3RydWUnKSAKICAgIGNvbnRleHQubG9nX2FydGlmYWN0KFBsb3RBcnRpZmFjdCgiY29uZnVzaW9uIiwgYm9keT1wbHQuZ2NmKCkpLCBsb2NhbF9wYXRoPWYie3Bsb3RzX2Rlc3R9L2NvbmZ1c2lvbi5odG1sIikKCg==
    commands: []
    code_origin: https://github.com/mlrun/functions.git#fad0c4e4805c720fb4e654a29ad09a9c80a85b2a:sklearn_classifier.ipynb
